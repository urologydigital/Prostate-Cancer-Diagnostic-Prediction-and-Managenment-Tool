<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Clinical decision support tool for prostate cancer pathway management based on NICE NG131, GIRFT 2024, and EAU 2024/2025 guidelines.">
    <meta name="keywords" content="prostate cancer, PSA, NICE guidelines, EAU guidelines, CPG, Cambridge Prognostic Group, urology, oncology">
    <meta name="author" content="NHS Urology Service">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
    <title>Prostate Cancer Pathway - Clinical Decision Support Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-input: #f8fafc;
            --accent-blue: #2563eb;
            --accent-cyan: #0891b2;
            --accent-green: #059669;
            --accent-amber: #d97706;
            --accent-red: #dc2626;
            --accent-purple: #7c3aed;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 32px;
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border-radius: var(--radius);
        }

        header h1 {
            font-size: 2rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .guidelines-badge {
            display: inline-flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .guidelines-badge span {
            background: var(--bg-secondary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .workflow-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-card);
            border-radius: 30px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .step-indicator:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .step-indicator.active {
            border-color: var(--accent-blue);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(8, 145, 178, 0.05));
        }

        .step-indicator.completed {
            border-color: var(--accent-green);
            background: rgba(5, 150, 105, 0.05);
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
        }

        .step-indicator.active .step-number {
            background: var(--accent-blue);
            color: white;
        }

        .step-indicator.completed .step-number {
            background: var(--accent-green);
            color: white;
        }

        .step-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .card-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .card-icon.blue { background: rgba(37, 99, 235, 0.1); }
        .card-icon.green { background: rgba(5, 150, 105, 0.1); }
        .card-icon.amber { background: rgba(217, 119, 6, 0.1); }
        .card-icon.purple { background: rgba(124, 58, 237, 0.1); }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        input, select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        select {
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            border-color: var(--accent-blue);
            background: rgba(37, 99, 235, 0.05);
        }

        .checkbox-item input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue);
        }

        .checkbox-item span {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            color: white;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.35);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent-blue);
            background: rgba(37, 99, 235, 0.05);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .result-panel {
            display: none;
        }

        .result-panel.visible {
            display: block;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert {
            padding: 16px 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-urgent {
            background: rgba(220, 38, 38, 0.08);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        .alert-urgent .alert-icon { color: var(--accent-red); }

        .alert-warning {
            background: rgba(217, 119, 6, 0.08);
            border: 1px solid rgba(217, 119, 6, 0.2);
        }

        .alert-warning .alert-icon { color: var(--accent-amber); }

        .alert-info {
            background: rgba(37, 99, 235, 0.08);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .alert-info .alert-icon { color: var(--accent-blue); }

        .alert-success {
            background: rgba(5, 150, 105, 0.08);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }

        .alert-success .alert-icon { color: var(--accent-green); }

        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .alert-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .investigation-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .investigation-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border-left: 4px solid var(--accent-blue);
        }

        .investigation-item.urgent {
            border-left-color: var(--accent-red);
            background: rgba(220, 38, 38, 0.05);
        }

        .investigation-item.recommended {
            border-left-color: var(--accent-green);
            background: rgba(5, 150, 105, 0.05);
        }

        .investigation-item.optional {
            border-left-color: var(--accent-amber);
            background: rgba(217, 119, 6, 0.05);
        }

        .investigation-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            border: 1px solid var(--border);
        }

        .investigation-details {
            flex: 1;
        }

        .investigation-name {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .investigation-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .investigation-priority {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-urgent {
            background: rgba(220, 38, 38, 0.15);
            color: var(--accent-red);
        }

        .priority-recommended {
            background: rgba(5, 150, 105, 0.15);
            color: var(--accent-green);
        }

        .priority-optional {
            background: rgba(217, 119, 6, 0.15);
            color: var(--accent-amber);
        }

        .cpg-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin: 24px 0;
        }

        .cpg-card {
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            color: white;
        }

        .cpg-card:hover {
            transform: translateY(-3px);
        }

        .cpg-card.selected {
            border-color: var(--text-primary);
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .cpg-1 { background: linear-gradient(135deg, #059669, #10b981); }
        .cpg-2 { background: linear-gradient(135deg, #0891b2, #06b6d4); }
        .cpg-3 { background: linear-gradient(135deg, #d97706, #f59e0b); }
        .cpg-4 { background: linear-gradient(135deg, #dc2626, #ef4444); }
        .cpg-5 { background: linear-gradient(135deg, #7c2d12, #991b1b); }

        .cpg-number {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
        }

        .cpg-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .management-section {
            margin-top: 24px;
        }

        .management-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-blue);
        }

        .management-list {
            list-style: none;
        }

        .management-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            color: var(--text-primary);
        }

        .management-list li:last-child {
            border-bottom: none;
        }

        .management-list li::before {
            content: "‚Üí";
            color: var(--accent-blue);
            font-weight: bold;
        }

        .timeline-note {
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
        }

        .timeline-icon {
            font-size: 1.5rem;
        }

        .timeline-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .timeline-text strong {
            color: var(--accent-blue);
        }

        .section-hidden {
            display: none;
        }

        .info-box {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.9rem;
            border: 1px solid var(--border);
        }

        .info-box-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent-blue);
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .tag {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .disclaimer {
            margin-top: 40px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .disclaimer-title {
            font-weight: 600;
            color: var(--accent-amber);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .disclaimer-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .workflow-steps {
                flex-direction: column;
                align-items: stretch;
            }

            .step-indicator {
                justify-content: flex-start;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .cpg-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .cpg-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Prostate Cancer Pathway Decision Support</h1>
            <p>Clinical guidance aligned with current national guidelines</p>
            <div class="guidelines-badge">
                <span>NICE NG131 (2021)</span>
                <span>GIRFT April 2024</span>
                <span>EAU 2024/2025</span>
                <span>AMRC Best Practice</span>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="resetAll()" style="font-size: 0.85rem; padding: 10px 20px; border-color: var(--accent-red);">
                    <span>üîÑ</span>
                    <span>Reset All / New Patient</span>
                </button>
            </div>
        </header>

        <div class="workflow-steps">
            <div class="step-indicator active" id="step1-indicator" onclick="showStep(1)">
                <div class="step-number">1</div>
                <span class="step-label">Assessment</span>
            </div>
            <div class="step-indicator" id="step2-indicator" onclick="showStep(2)">
                <div class="step-number">2</div>
                <span class="step-label">Investigations</span>
            </div>
            <div class="step-indicator" id="step3-indicator" onclick="showStep(3)">
                <div class="step-number">3</div>
                <span class="step-label">CPG Calculator</span>
            </div>
            <div class="step-indicator" id="step4-indicator" onclick="showStep(4)">
                <div class="step-number">4</div>
                <span class="step-label">Risk & Prognosis</span>
            </div>
            <div class="step-indicator" id="step5-indicator" onclick="showStep(5)">
                <div class="step-number">5</div>
                <span class="step-label">Treatments</span>
            </div>
            <div class="step-indicator" id="step6-indicator" onclick="showStep(6)">
                <div class="step-number">6</div>
                <span class="step-label">Follow-up</span>
            </div>
            <div class="step-indicator" id="step7-indicator" onclick="showStep(7)">
                <div class="step-number">7</div>
                <span class="step-label">Progression</span>
            </div>
            <div class="step-indicator" id="step8-indicator" onclick="showStep(8)">
                <div class="step-number">8</div>
                <span class="step-label">Clinical Dx</span>
            </div>
        </div>

        <!-- Step 1: Patient Assessment -->
        <div id="step1" class="card">
            <div class="card-header">
                <div class="card-icon blue">üìã</div>
                <div>
                    <div class="card-title">Step 1: Patient Assessment</div>
                    <div class="card-subtitle">Initial referral pathway based on PSA, age, DRE, and risk factors - GIRFT 2024 & NICE NG131</div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="age">Patient Age (years)</label>
                    <input type="number" id="age" placeholder="e.g., 65" min="18" max="120">
                </div>

                <div class="form-group">
                    <label for="psa">PSA Level (ng/ml)</label>
                    <input type="number" id="psa" placeholder="e.g., 5.2" step="0.1" min="0">
                </div>

                <div class="form-group">
                    <label for="dre">Digital Rectal Examination (DRE)</label>
                    <select id="dre">
                        <option value="">Select DRE result...</option>
                        <option value="normal">Normal</option>
                        <option value="abnormal">Abnormal / Suspicious</option>
                        <option value="not-done">Not performed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fitness">Fitness for Treatment</label>
                    <select id="fitness">
                        <option value="">Select fitness status...</option>
                        <option value="fit">Fit for radical treatment</option>
                        <option value="unfit">Unfit / significant comorbidities</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label>Risk Factors</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="family-history">
                            <span>Family history of prostate cancer</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="brca2">
                            <span>BRCA2 mutation carrier</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="african-caribbean">
                            <span>African/Caribbean ethnicity</span>
                        </label>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>Symptoms Present</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="luts">
                            <span>LUTS (urinary symptoms)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="bone-pain">
                            <span>Bone pain</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="weight-loss">
                            <span>Unexplained weight loss</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="fatigue">
                            <span>Fatigue</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="assessPatient()">
                    <span>Assess & Determine Pathway</span>
                    <span>‚Üí</span>
                </button>
                <button class="btn btn-secondary" onclick="resetStep1()">
                    <span>üîÑ Reset This Module</span>
                </button>
            </div>
        </div>

        <!-- Step 1 Results -->
        <div id="step1-results" class="result-panel">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon green">üìä</div>
                    <div>
                        <div class="card-title">Referral Assessment</div>
                        <div class="card-subtitle">Based on GIRFT 2024 and NICE NG131 criteria</div>
                    </div>
                </div>
                <div id="referral-decision"></div>
            </div>
        </div>

        <!-- Step 2: Investigation Results -->
        <div id="step2" class="card section-hidden">
            <div class="card-header">
                <div class="card-icon amber">üî¨</div>
                <div>
                    <div class="card-title">Step 2: Investigation Results</div>
                    <div class="card-subtitle">MRI findings, PSAD calculation, and biopsy results</div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="s2-psa">PSA Level (ng/ml)</label>
                    <input type="number" id="s2-psa" placeholder="e.g., 8.5" step="0.1" min="0" oninput="calculatePSAD()">
                </div>
                <div class="form-group">
                    <label for="pirads">PI-RADS Score (MRI)</label>
                    <select id="pirads">
                        <option value="">Select PI-RADS score...</option>
                        <option value="1">PI-RADS 1 - Very Low</option>
                        <option value="2">PI-RADS 2 - Low</option>
                        <option value="3">PI-RADS 3 - Intermediate</option>
                        <option value="4">PI-RADS 4 - High</option>
                        <option value="5">PI-RADS 5 - Very High</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="prostate-volume">Prostate Volume (ml)</label>
                    <input type="number" id="prostate-volume" placeholder="e.g., 40" min="1">
                </div>

                <div class="form-group">
                    <label for="psad">PSA Density (auto-calculated)</label>
                    <input type="text" id="psad" readonly placeholder="Will calculate automatically">
                </div>

                <div class="form-group">
                    <label for="biopsy-done">Biopsy Performed?</label>
                    <select id="biopsy-done" onchange="toggleBiopsyResults()">
                        <option value="">Select...</option>
                        <option value="yes">Yes - cancer detected</option>
                        <option value="negative">Yes - negative for cancer</option>
                        <option value="no">No - not performed</option>
                    </select>
                </div>
            </div>

            <div id="biopsy-results" class="section-hidden" style="margin-top: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="gleason">Gleason Score / Grade Group</label>
                        <select id="gleason">
                            <option value="">Select Grade Group...</option>
                            <option value="1">GG1 (Gleason 3+3 = 6)</option>
                            <option value="2">GG2 (Gleason 3+4 = 7)</option>
                            <option value="3">GG3 (Gleason 4+3 = 7)</option>
                            <option value="4">GG4 (Gleason 8)</option>
                            <option value="5">GG5 (Gleason 9-10)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="t-stage">T Stage</label>
                        <select id="t-stage">
                            <option value="">Select T Stage...</option>
                            <option value="T1">T1 (clinically inapparent)</option>
                            <option value="T2a">T2a (‚â§half of one lobe)</option>
                            <option value="T2b">T2b (>half of one lobe)</option>
                            <option value="T2c">T2c (both lobes)</option>
                            <option value="T3">T3 (extracapsular extension)</option>
                            <option value="T4">T4 (invades adjacent structures)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="processInvestigations()">
                    <span>Process Results</span>
                    <span>‚Üí</span>
                </button>
                <button class="btn btn-secondary" onclick="resetStep2()">
                    <span>üîÑ Reset This Module</span>
                </button>
            </div>
        </div>

        <!-- Step 2 Results -->
        <div id="step2-results" class="result-panel">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon purple">üìã</div>
                    <div>
                        <div class="card-title">MRI-Based Recommendations</div>
                        <div class="card-subtitle">PSAD-guided biopsy decision</div>
                    </div>
                </div>
                <div id="mri-recommendation"></div>
            </div>
        </div>

        <!-- Step 3: CPG Calculator -->
        <div id="step3" class="card section-hidden">
            <div class="card-header">
                <div class="card-icon green">üßÆ</div>
                <div>
                    <div class="card-title">Step 3: CPG Calculator</div>
                    <div class="card-subtitle">Cambridge Prognostic Group calculation from biopsy results - NICE NG131 & EAU 2024</div>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="quick-psa">PSA Level (ng/ml)</label>
                    <input type="number" id="quick-psa" placeholder="e.g., 8.5" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label for="quick-gleason">Grade Group</label>
                    <select id="quick-gleason">
                        <option value="">Select Grade Group...</option>
                        <option value="1">GG1 (Gleason 3+3 = 6)</option>
                        <option value="2">GG2 (Gleason 3+4 = 7)</option>
                        <option value="3">GG3 (Gleason 4+3 = 7)</option>
                        <option value="4">GG4 (Gleason 8)</option>
                        <option value="5">GG5 (Gleason 9-10)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quick-tstage">T Stage</label>
                    <select id="quick-tstage">
                        <option value="">Select T Stage...</option>
                        <option value="T1">T1 (clinically inapparent)</option>
                        <option value="T2a">T2a (‚â§half of one lobe)</option>
                        <option value="T2b">T2b (>half of one lobe)</option>
                        <option value="T2c">T2c (both lobes)</option>
                        <option value="T3">T3 (extracapsular extension)</option>
                        <option value="T4">T4 (invades adjacent structures)</option>
                    </select>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculateQuickCPG()">
                    <span>Calculate CPG</span>
                    <span>‚Üí</span>
                </button>
                <button class="btn btn-secondary" onclick="resetStep3()">
                    <span>üîÑ Reset This Module</span>
                </button>
            </div>
            
            <div id="cpg-result" style="margin-top: 24px;"></div>
        </div>

        <!-- Clinical Diagnosis Module (No Biopsy) - Step 8 -->
        <div id="step8" class="card section-hidden">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(239, 68, 68, 0.2));">ü©∫</div>
                <div>
                    <div class="card-title">Step 8: Clinical Diagnosis (No Biopsy)</div>
                    <div class="card-subtitle">Management for patients diagnosed clinically without histology - NICE NG131 & EAU 2024</div>
                </div>
            </div>

            <div class="alert alert-warning" style="margin-bottom: 24px;">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <div class="alert-title">Clinical Diagnosis Without Histology</div>
                    <div class="alert-text">
                        This pathway is for patients where biopsy is not performed due to: advanced age/frailty, 
                        clear metastatic disease on imaging, very high PSA with clinical features, or patient choice. 
                        Management is based on clinical staging per NICE NG131 and EAU guidelines.
                    </div>
                </div>
            </div>

            <!-- Patient Details -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Patient Details</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cd-age">Age (years)</label>
                        <input type="number" id="cd-age" placeholder="e.g., 82" min="18" max="120">
                    </div>
                    <div class="form-group">
                        <label for="cd-performance">WHO Performance Status</label>
                        <select id="cd-performance">
                            <option value="">Select...</option>
                            <option value="0">PS 0 - Fully active</option>
                            <option value="1">PS 1 - Restricted strenuous activity</option>
                            <option value="2">PS 2 - Ambulatory, capable of self-care</option>
                            <option value="3">PS 3 - Limited self-care, >50% in bed</option>
                            <option value="4">PS 4 - Completely disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cd-life-expectancy">Estimated Life Expectancy</label>
                        <select id="cd-life-expectancy">
                            <option value="">Select...</option>
                            <option value="less1">< 1 year</option>
                            <option value="1-2">1-2 years</option>
                            <option value="2-5">2-5 years</option>
                            <option value="5-10">5-10 years</option>
                            <option value="more10">> 10 years</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cd-frailty">Frailty Status</label>
                        <select id="cd-frailty">
                            <option value="">Select...</option>
                            <option value="fit">Fit - Independent</option>
                            <option value="mild">Mild frailty</option>
                            <option value="moderate">Moderate frailty</option>
                            <option value="severe">Severe frailty</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- PSA and Clinical Findings -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">PSA & Clinical Findings</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cd-psa">PSA Level (ng/ml)</label>
                        <input type="number" id="cd-psa" placeholder="e.g., 150" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label for="cd-psa-trend">PSA Trend</label>
                        <select id="cd-psa-trend">
                            <option value="">Select...</option>
                            <option value="unknown">Unknown / First test</option>
                            <option value="stable">Stable</option>
                            <option value="rising-slow">Rising slowly (<2 ng/ml/year)</option>
                            <option value="rising-fast">Rising rapidly (>2 ng/ml/year)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cd-dre">DRE Findings</label>
                        <select id="cd-dre">
                            <option value="">Select...</option>
                            <option value="normal">Normal</option>
                            <option value="enlarged-smooth">Enlarged, smooth (likely BPH)</option>
                            <option value="nodule">Nodule / Induration</option>
                            <option value="hard-irregular">Hard, irregular</option>
                            <option value="fixed">Fixed to surrounding tissue</option>
                            <option value="not-done">Not performed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cd-clinical-t">Clinical T Stage (based on DRE)</label>
                        <select id="cd-clinical-t">
                            <option value="">Select...</option>
                            <option value="T1">T1 - Not palpable</option>
                            <option value="T2">T2 - Confined to prostate</option>
                            <option value="T3">T3 - Extracapsular extension</option>
                            <option value="T4">T4 - Fixed / invades adjacent organs</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Symptoms -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Presenting Symptoms</h3>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-luts">
                        <span>LUTS (urinary symptoms)</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-retention">
                        <span>Urinary retention</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-haematuria">
                        <span>Haematuria</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-bone-pain">
                        <span>Bone pain</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-back-pain">
                        <span>Back pain / Spinal symptoms</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-weight-loss">
                        <span>Weight loss</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-fatigue">
                        <span>Fatigue / Malaise</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-anaemia">
                        <span>Anaemia</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-cord-compression">
                        <span>Spinal cord compression symptoms</span>
                    </label>
                </div>
            </div>

            <!-- Imaging Results -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Imaging Results</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cd-mri">MRI Prostate (if performed)</label>
                        <select id="cd-mri">
                            <option value="">Select...</option>
                            <option value="not-done">Not performed</option>
                            <option value="suspicious">Suspicious lesion (PI-RADS 4-5)</option>
                            <option value="local-advanced">Locally advanced disease</option>
                            <option value="node-positive">Pelvic node involvement</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cd-bone-scan">Bone Scan</label>
                        <select id="cd-bone-scan">
                            <option value="">Select...</option>
                            <option value="not-done">Not performed</option>
                            <option value="negative">Negative</option>
                            <option value="equivocal">Equivocal</option>
                            <option value="positive-limited">Positive - Limited (‚â§3 lesions)</option>
                            <option value="positive-extensive">Positive - Extensive (>3 lesions)</option>
                            <option value="superscan">Superscan pattern</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cd-ct">CT Staging</label>
                        <select id="cd-ct">
                            <option value="">Select...</option>
                            <option value="not-done">Not performed</option>
                            <option value="negative">No metastases</option>
                            <option value="nodes-pelvic">Pelvic lymph nodes only</option>
                            <option value="nodes-distant">Para-aortic / distant nodes</option>
                            <option value="visceral">Visceral metastases</option>
                            <option value="bone-lesions">Bone lesions seen</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cd-psma">PSMA PET-CT (if performed)</label>
                        <select id="cd-psma">
                            <option value="">Select...</option>
                            <option value="not-done">Not performed</option>
                            <option value="local">Local disease only</option>
                            <option value="nodal">Nodal disease</option>
                            <option value="oligomet">Oligometastatic (‚â§5 lesions)</option>
                            <option value="polymet">Polymetastatic (>5 lesions)</option>
                            <option value="widespread">Widespread metastases</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Reason for No Biopsy -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Reason for Clinical Diagnosis (No Biopsy)</h3>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-reason-frailty">
                        <span>Patient frailty / Not fit for biopsy</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-reason-metastatic">
                        <span>Clear metastatic disease - histology won't change management</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-reason-psa">
                        <span>Very high PSA (>100) with typical clinical features</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-reason-life-expectancy">
                        <span>Limited life expectancy</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-reason-patient-choice">
                        <span>Patient declined biopsy after counselling</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="cd-reason-anticoag">
                        <span>Anticoagulation / Bleeding risk</span>
                    </label>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculateClinicalDiagnosis()">
                    <span>Generate Management Plan</span>
                    <span>‚Üí</span>
                </button>
                <button class="btn btn-secondary" onclick="resetStep8()">
                    <span>üîÑ Reset This Module</span>
                </button>
            </div>
        </div>

        <!-- Clinical Diagnosis Results -->
        <div id="step8-results" class="result-panel">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(16, 185, 129, 0.2));">üìã</div>
                    <div>
                        <div class="card-title">Clinical Diagnosis - Management Plan</div>
                        <div class="card-subtitle">Based on NICE NG131 & EAU 2024 Guidelines for clinically diagnosed prostate cancer</div>
                    </div>
                </div>
                <div id="clinical-diagnosis-output"></div>
            </div>
        </div>

        <!-- Step 4: Comprehensive Risk Stratification & Prognosis -->
        <div id="step4" class="card section-hidden">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(245, 158, 11, 0.2));">üìà</div>
                <div>
                    <div class="card-title">Step 4: Comprehensive Risk Stratification & Prognosis</div>
                    <div class="card-subtitle">Full TNM staging, EAU risk groups, treatment & prognosis - NICE NG131 & EAU 2024/2025</div>
                </div>
            </div>

            <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-cyan);">
                <div class="info-box-title">üìã Complete All Available Staging Information</div>
                <p style="color: var(--text-secondary); font-size: 0.85rem;">Enter all investigation results to calculate comprehensive risk stratification, treatment recommendations, and prognosis estimates.</p>
            </div>

            <!-- Patient Demographics Section -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Patient Demographics</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="s4-age">Age (years)</label>
                        <input type="number" id="s4-age" placeholder="e.g., 65" min="18" max="120">
                    </div>
                    <div class="form-group">
                        <label for="s4-performance">WHO Performance Status</label>
                        <select id="s4-performance">
                            <option value="">Select...</option>
                            <option value="0">PS 0 - Fully active</option>
                            <option value="1">PS 1 - Restricted strenuous activity</option>
                            <option value="2">PS 2 - Ambulatory, capable of self-care</option>
                            <option value="3">PS 3 - Limited self-care, >50% in bed</option>
                            <option value="4">PS 4 - Completely disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-life-expectancy">Estimated Life Expectancy</label>
                        <select id="s4-life-expectancy">
                            <option value="">Select...</option>
                            <option value="less5">< 5 years</option>
                            <option value="5-10">5-10 years</option>
                            <option value="10-15">10-15 years</option>
                            <option value="more15">> 15 years</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-comorbidities">Significant Comorbidities</label>
                        <select id="s4-comorbidities">
                            <option value="">Select...</option>
                            <option value="none">None / Minimal</option>
                            <option value="moderate">Moderate (CCI 1-2)</option>
                            <option value="severe">Severe (CCI ‚â•3)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tumour Markers Section -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Tumour Markers & Histology</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="s4-psa">PSA Level (ng/ml)</label>
                        <input type="number" id="s4-psa" placeholder="e.g., 15.5" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label for="s4-psa-velocity">PSA Velocity (ng/ml/year)</label>
                        <input type="number" id="s4-psa-velocity" placeholder="e.g., 2.1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="s4-psa-doubling">PSA Doubling Time (months)</label>
                        <input type="number" id="s4-psa-doubling" placeholder="e.g., 12" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="s4-gleason">Grade Group (ISUP)</label>
                        <select id="s4-gleason">
                            <option value="">Select Grade Group...</option>
                            <option value="1">GG1 (Gleason 3+3 = 6)</option>
                            <option value="2">GG2 (Gleason 3+4 = 7)</option>
                            <option value="3">GG3 (Gleason 4+3 = 7)</option>
                            <option value="4">GG4 (Gleason 8)</option>
                            <option value="5">GG5 (Gleason 9-10)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-cores-positive">Positive Cores / Total Cores</label>
                        <input type="text" id="s4-cores-positive" placeholder="e.g., 4/12">
                    </div>
                    <div class="form-group">
                        <label for="s4-max-core">Max Cancer in Single Core (%)</label>
                        <input type="number" id="s4-max-core" placeholder="e.g., 60" min="0" max="100">
                    </div>
                </div>
            </div>

            <!-- Clinical Examination Section -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Clinical Examination</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="s4-dre">DRE Findings</label>
                        <select id="s4-dre">
                            <option value="">Select...</option>
                            <option value="normal">Normal</option>
                            <option value="nodule">Nodule palpable</option>
                            <option value="induration">Induration</option>
                            <option value="fixed">Fixed / Locally advanced</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- MRI Findings Section -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">MRI Findings (mpMRI)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="s4-pirads">PI-RADS Score</label>
                        <select id="s4-pirads">
                            <option value="">Select...</option>
                            <option value="1">PI-RADS 1 - Very Low</option>
                            <option value="2">PI-RADS 2 - Low</option>
                            <option value="3">PI-RADS 3 - Intermediate</option>
                            <option value="4">PI-RADS 4 - High</option>
                            <option value="5">PI-RADS 5 - Very High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-prostate-volume">Prostate Volume (ml)</label>
                        <input type="number" id="s4-prostate-volume" placeholder="e.g., 45" min="1">
                    </div>
                    <div class="form-group">
                        <label for="s4-lesion-size">Dominant Lesion Size (mm)</label>
                        <input type="number" id="s4-lesion-size" placeholder="e.g., 15" min="0">
                    </div>
                    <div class="form-group">
                        <label for="s4-epe">Extraprostatic Extension (EPE)</label>
                        <select id="s4-epe">
                            <option value="">Select...</option>
                            <option value="no">No EPE</option>
                            <option value="suspected">Suspected EPE</option>
                            <option value="definite">Definite EPE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-svi">Seminal Vesicle Invasion</label>
                        <select id="s4-svi">
                            <option value="">Select...</option>
                            <option value="no">No SVI</option>
                            <option value="suspected">Suspected SVI</option>
                            <option value="definite">Definite SVI</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-lymph-mri">Pelvic Lymph Nodes (MRI)</label>
                        <select id="s4-lymph-mri">
                            <option value="">Select...</option>
                            <option value="normal">Normal</option>
                            <option value="suspicious">Suspicious enlargement</option>
                            <option value="definite">Definite involvement</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- TNM Staging Section -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">TNM Classification (AJCC 8th Edition)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="s4-t-stage">T Stage (Primary Tumour)</label>
                        <select id="s4-t-stage">
                            <option value="">Select T Stage...</option>
                            <option value="T1a">T1a - ‚â§5% of resected tissue</option>
                            <option value="T1b">T1b - >5% of resected tissue</option>
                            <option value="T1c">T1c - Needle biopsy (PSA detected)</option>
                            <option value="T2a">T2a - ‚â§half of one lobe</option>
                            <option value="T2b">T2b - >half of one lobe</option>
                            <option value="T2c">T2c - Both lobes</option>
                            <option value="T3a">T3a - Extracapsular extension</option>
                            <option value="T3b">T3b - Seminal vesicle invasion</option>
                            <option value="T4">T4 - Fixed or invades adjacent structures</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-n-stage">N Stage (Regional Lymph Nodes)</label>
                        <select id="s4-n-stage">
                            <option value="">Select N Stage...</option>
                            <option value="N0">N0 - No regional lymph node metastasis</option>
                            <option value="N1">N1 - Regional lymph node metastasis</option>
                            <option value="Nx">Nx - Cannot be assessed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-m-stage">M Stage (Distant Metastasis)</label>
                        <select id="s4-m-stage">
                            <option value="">Select M Stage...</option>
                            <option value="M0">M0 - No distant metastasis</option>
                            <option value="M1a">M1a - Non-regional lymph nodes</option>
                            <option value="M1b">M1b - Bone metastases</option>
                            <option value="M1c">M1c - Other sites (¬± bone)</option>
                            <option value="Mx">Mx - Cannot be assessed</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Staging Investigations Section -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Staging Investigations</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="s4-bone-scan">Bone Scan (Tc-99m)</label>
                        <select id="s4-bone-scan">
                            <option value="">Select...</option>
                            <option value="not-done">Not performed</option>
                            <option value="negative">Negative - No metastases</option>
                            <option value="equivocal">Equivocal - Uncertain findings</option>
                            <option value="positive-oligo">Positive - Oligometastatic (‚â§3 lesions)</option>
                            <option value="positive-poly">Positive - Polymetastatic (>3 lesions)</option>
                            <option value="positive-high">Positive - High volume (‚â•4 lesions with ‚â•1 outside spine/pelvis)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-ct-cap">CT Chest/Abdomen/Pelvis</label>
                        <select id="s4-ct-cap">
                            <option value="">Select...</option>
                            <option value="not-done">Not performed</option>
                            <option value="negative">Negative - No metastases</option>
                            <option value="lymph-only">Lymph node involvement only</option>
                            <option value="visceral">Visceral metastases present</option>
                            <option value="both">Lymph nodes + visceral metastases</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="s4-psma-pet">PSMA PET-CT</label>
                        <select id="s4-psma-pet">
                            <option value="">Select...</option>
                            <option value="not-done">Not performed</option>
                            <option value="negative">Negative - No uptake beyond prostate</option>
                            <option value="local-only">Local disease only</option>
                            <option value="pelvic-nodes">Pelvic lymph node positive</option>
                            <option value="distant-nodes">Distant lymph node positive</option>
                            <option value="bone-oligo">Bone metastases - Oligometastatic (‚â§5)</option>
                            <option value="bone-poly">Bone metastases - Polymetastatic (>5)</option>
                            <option value="visceral">Visceral metastases</option>
                            <option value="widespread">Widespread metastatic disease</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Additional Prognostic Factors -->
            <div style="margin-bottom: 28px;">
                <h3 style="font-size: 1rem; color: var(--accent-cyan); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Additional Prognostic Factors</h3>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" id="s4-perineural">
                        <span>Perineural invasion present</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="s4-lymphovascular">
                        <span>Lymphovascular invasion present</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="s4-cribriform">
                        <span>Cribriform pattern present</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="s4-intraductal">
                        <span>Intraductal carcinoma present</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="s4-brca">
                        <span>BRCA1/2 mutation carrier</span>
                    </label>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculateComprehensiveRisk()">
                    <span>Calculate Risk & Generate Report</span>
                    <span>‚Üí</span>
                </button>
                <button class="btn btn-secondary" onclick="resetStep4()">
                    <span>üîÑ Reset This Module</span>
                </button>
            </div>
        </div>

        <!-- Step 4 Results -->
        <div id="step4-results" class="result-panel">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2));">üìä</div>
                    <div>
                        <div class="card-title">Comprehensive Risk Assessment & Treatment Plan</div>
                        <div class="card-subtitle">Based on NICE NG131 & EAU 2024/2025 Guidelines</div>
                    </div>
                </div>
                <div id="comprehensive-results"></div>
            </div>
        </div>

        <!-- Step 5: Treatment Options -->
        <div id="step5" class="card section-hidden">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(37, 99, 235, 0.2));">üíä</div>
                <div>
                    <div class="card-title">Step 5: Treatment Options & Information</div>
                    <div class="card-subtitle">Detailed treatment information with pros, cons, risks & BAUS patient leaflets</div>
                </div>
            </div>

            <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-cyan);">
                <div class="info-box-title">üìã Select Treatment to View Details</div>
                <p style="color: var(--text-secondary); font-size: 0.85rem;">Choose a treatment modality to see comprehensive information including benefits, risks, and patient information resources.</p>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="s5-risk-group">Patient Risk Group</label>
                    <select id="s5-risk-group">
                        <option value="">Select risk group...</option>
                        <option value="low">Low Risk (CPG 1)</option>
                        <option value="intermediate-favourable">Intermediate Risk - Favourable (CPG 2)</option>
                        <option value="intermediate-unfavourable">Intermediate Risk - Unfavourable (CPG 3)</option>
                        <option value="high">High Risk (CPG 4)</option>
                        <option value="very-high">Very High Risk (CPG 5)</option>
                        <option value="metastatic">Metastatic Disease</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="s5-age">Patient Age (years)</label>
                    <input type="number" id="s5-age" placeholder="e.g., 65" min="18" max="120">
                </div>
                <div class="form-group">
                    <label for="s5-life-expectancy">Life Expectancy</label>
                    <select id="s5-life-expectancy">
                        <option value="">Select...</option>
                        <option value="less10">< 10 years</option>
                        <option value="10-15">10-15 years</option>
                        <option value="more15">> 15 years</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="s5-treatment">Treatment Modality</label>
                    <select id="s5-treatment" onchange="showTreatmentDetails()">
                        <option value="">Select treatment...</option>
                        <optgroup label="Surveillance">
                            <option value="active-surveillance">Active Surveillance</option>
                            <option value="watchful-waiting">Watchful Waiting</option>
                        </optgroup>
                        <optgroup label="Surgery">
                            <option value="radical-prostatectomy">Radical Prostatectomy</option>
                        </optgroup>
                        <optgroup label="Radiotherapy">
                            <option value="ebrt">External Beam Radiotherapy (EBRT)</option>
                            <option value="brachytherapy-ldr">Brachytherapy - Low Dose Rate (LDR)</option>
                            <option value="brachytherapy-hdr">Brachytherapy - High Dose Rate (HDR) Boost</option>
                            <option value="sbrt">SBRT/SABR (5-Fraction Hypofractionated RT)</option>
                        </optgroup>
                        <optgroup label="Focal Therapy">
                            <option value="hifu">High Intensity Focused Ultrasound (HIFU)</option>
                            <option value="cryotherapy">Cryotherapy</option>
                        </optgroup>
                        <optgroup label="Systemic Therapy">
                            <option value="adt">Androgen Deprivation Therapy (ADT)</option>
                            <option value="adt-novel">ADT + Novel Hormonal Agent</option>
                            <option value="chemotherapy">Chemotherapy (Docetaxel)</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div id="treatment-details" style="margin-top: 24px;"></div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="showTreatmentDetails()">
                    <span>Show Treatment Information</span>
                    <span>‚Üí</span>
                </button>
                <button class="btn btn-secondary" onclick="resetStep5()">
                    <span>üîÑ Reset This Module</span>
                </button>
            </div>
        </div>

        <!-- Step 6: Follow-up Protocols -->
        <div id="step6" class="card section-hidden">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, rgba(8, 145, 178, 0.2), rgba(16, 185, 129, 0.2));">üìÖ</div>
                <div>
                    <div class="card-title">Step 6: Follow-up Protocols</div>
                    <div class="card-subtitle">Post-treatment surveillance schedules based on treatment type and risk group</div>
                </div>
            </div>

            <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-cyan);">
                <div class="info-box-title">üìã Generate Personalised Follow-up Schedule</div>
                <p style="color: var(--text-secondary); font-size: 0.85rem;">Enter treatment details to generate a comprehensive follow-up protocol with investigation schedule and discharge criteria.</p>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="s6-treatment">Treatment Received</label>
                    <select id="s6-treatment">
                        <option value="">Select treatment...</option>
                        <option value="active-surveillance">Active Surveillance</option>
                        <option value="watchful-waiting">Watchful Waiting</option>
                        <option value="radical-prostatectomy">Radical Prostatectomy</option>
                        <option value="ebrt">External Beam Radiotherapy</option>
                        <option value="ebrt-adt">EBRT + ADT</option>
                        <option value="brachytherapy">Brachytherapy (LDR/HDR)</option>
                        <option value="sbrt">SBRT (5-Fraction RT)</option>
                        <option value="hifu">HIFU</option>
                        <option value="cryotherapy">Cryotherapy</option>
                        <option value="adt-only">ADT Alone</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="s6-treatment-date">Treatment Completion Date</label>
                    <input type="date" id="s6-treatment-date">
                </div>
                <div class="form-group">
                    <label for="s6-risk-group">Pre-treatment Risk Group</label>
                    <select id="s6-risk-group">
                        <option value="">Select risk group...</option>
                        <option value="low">Low Risk</option>
                        <option value="intermediate">Intermediate Risk</option>
                        <option value="high">High Risk</option>
                        <option value="very-high">Very High Risk / Locally Advanced</option>
                        <option value="metastatic">Metastatic</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="s6-age">Patient Age at Treatment (years)</label>
                    <input type="number" id="s6-age" placeholder="e.g., 65" min="18" max="120">
                </div>
                <div class="form-group">
                    <label for="s6-psa-nadir">Post-treatment PSA Nadir (ng/ml)</label>
                    <input type="number" id="s6-psa-nadir" placeholder="e.g., 0.03" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="s6-margins">Surgical Margins (if RP)</label>
                    <select id="s6-margins">
                        <option value="">Select if applicable...</option>
                        <option value="negative">Negative (R0)</option>
                        <option value="positive">Positive (R1)</option>
                        <option value="na">N/A - Not Surgery</option>
                    </select>
                </div>
            </div>

            <div id="followup-schedule" style="margin-top: 24px;"></div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="generateFollowupSchedule()">
                    <span>Generate Follow-up Schedule</span>
                    <span>‚Üí</span>
                </button>
                <button class="btn btn-secondary" onclick="resetStep6()">
                    <span>üîÑ Reset This Module</span>
                </button>
            </div>
        </div>

        <!-- Step 7: Biochemical Progression Management -->
        <div id="step7" class="card section-hidden">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(245, 158, 11, 0.2));">‚ö†Ô∏è</div>
                <div>
                    <div class="card-title">Step 7: Biochemical Progression & Recurrence</div>
                    <div class="card-subtitle">Management of PSA rise, clinical progression and treatment options</div>
                </div>
            </div>

            <div class="alert alert-warning" style="margin-bottom: 24px;">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <div class="alert-title">Suspected Disease Progression</div>
                    <div class="alert-text">Enter details about the original treatment and current progression to generate management recommendations.</div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="s7-initial-treatment">Initial Treatment</label>
                    <select id="s7-initial-treatment">
                        <option value="">Select initial treatment...</option>
                        <option value="radical-prostatectomy">Radical Prostatectomy</option>
                        <option value="ebrt">External Beam Radiotherapy</option>
                        <option value="ebrt-adt">EBRT + ADT</option>
                        <option value="brachytherapy">Brachytherapy</option>
                        <option value="hifu">HIFU</option>
                        <option value="active-surveillance">Active Surveillance (now progressed)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="s7-treatment-date">Date of Initial Treatment</label>
                    <input type="date" id="s7-treatment-date">
                </div>
                <div class="form-group">
                    <label for="s7-age">Current Age (years)</label>
                    <input type="number" id="s7-age" placeholder="e.g., 70" min="18" max="120">
                </div>
                <div class="form-group">
                    <label for="s7-psa-nadir">Post-treatment PSA Nadir (ng/ml)</label>
                    <input type="number" id="s7-psa-nadir" placeholder="e.g., 0.01" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="s7-current-psa">Current PSA (ng/ml)</label>
                    <input type="number" id="s7-current-psa" placeholder="e.g., 0.5" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="s7-psa-doubling">PSA Doubling Time (months)</label>
                    <input type="number" id="s7-psa-doubling" placeholder="e.g., 8" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label for="s7-original-gleason">Original Grade Group</label>
                    <select id="s7-original-gleason">
                        <option value="">Select...</option>
                        <option value="1">GG1 (Gleason 6)</option>
                        <option value="2">GG2 (Gleason 3+4)</option>
                        <option value="3">GG3 (Gleason 4+3)</option>
                        <option value="4">GG4 (Gleason 8)</option>
                        <option value="5">GG5 (Gleason 9-10)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="s7-progression-type">Type of Progression</label>
                    <select id="s7-progression-type">
                        <option value="">Select...</option>
                        <option value="biochemical">Biochemical only (PSA rise)</option>
                        <option value="local">Local recurrence (imaging positive)</option>
                        <option value="nodal">Nodal recurrence</option>
                        <option value="metastatic">Distant metastases</option>
                        <option value="symptomatic">Symptomatic progression</option>
                    </select>
                </div>
            </div>

            <div class="form-group full-width" style="margin-top: 16px;">
                <label>Current Symptoms</label>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" id="s7-asymptomatic">
                        <span>Asymptomatic</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="s7-bone-pain">
                        <span>Bone pain</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="s7-luts">
                        <span>Urinary symptoms</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="s7-fatigue">
                        <span>Fatigue / Constitutional symptoms</span>
                    </label>
                </div>
            </div>

            <div id="progression-management" style="margin-top: 24px;"></div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="generateProgressionManagement()">
                    <span>Generate Management Plan</span>
                    <span>‚Üí</span>
                </button>
                <button class="btn btn-secondary" onclick="resetStep7()">
                    <span>üîÑ Reset This Module</span>
                </button>
            </div>
        </div>

        <div class="disclaimer">
            <div class="disclaimer-title">
                <span>‚ö†Ô∏è</span>
                <span>Important Clinical Notice</span>
            </div>
            <div class="disclaimer-text">
                <p><strong>FOR CLINICAL REFERENCE ONLY - NOT A MEDICAL DEVICE</strong></p>
                <p style="margin-top: 12px;">
                    This tool provides guidance based on NICE NG131 (2019, updated 2021), GIRFT Urology (April 2024), 
                    EAU-EANM-ESTRO-ESUR-ISUP-SIOG Guidelines (2024/2025), and AMRC Best Practice recommendations.
                </p>
                <p style="margin-top: 12px;">
                    <strong>Clinical Governance:</strong> This tool is intended to support, not replace, clinical decision-making. 
                    All management decisions must be individualised based on patient circumstances, preferences, comorbidities, 
                    and local resources. All cancer diagnoses must be discussed at the Multidisciplinary Team (MDT) meeting.
                </p>
                <p style="margin-top: 12px;">
                    <strong>Limitations:</strong> Prognosis estimates are population-based approximations and may not reflect 
                    individual patient outcomes. Guidelines are subject to change - verify against current published guidance.
                </p>
                <p style="margin-top: 12px;">
                    <strong>Data Protection:</strong> This tool does not store or transmit any patient data. All calculations 
                    are performed locally in your browser. No information is saved between sessions.
                </p>
                <p style="margin-top: 12px; font-size: 0.8rem; color: var(--text-muted);">
                    Version 2.0 | Last Updated: December 2025 | Review Date: December 2026
                </p>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let patientData = {};

        // Auto-calculate PSAD when PSA or volume changes
        document.getElementById('prostate-volume').addEventListener('input', calculatePSAD);
        document.getElementById('s2-psa').addEventListener('input', calculatePSAD);
        
        function calculatePSAD() {
            // Try to get PSA from Step 2's own field first, then from Step 1
            let psa = parseFloat(document.getElementById('s2-psa').value);
            if (!psa) {
                psa = parseFloat(document.getElementById('psa').value);
            }
            const volume = parseFloat(document.getElementById('prostate-volume').value);
            
            if (psa && volume && volume > 0) {
                const psad = (psa / volume).toFixed(3);
                document.getElementById('psad').value = psad + ' ng/ml/ml';
                patientData.psad = parseFloat(psad);
                patientData.psa = psa;
            }
        }

        function showStep(step) {
            // Update step indicators - highlight selected step
            for (let i = 1; i <= 8; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                if (indicator) indicator.classList.remove('active');
            }
            document.getElementById(`step${step}-indicator`).classList.add('active');

            // Show/hide sections - show only the selected step
            for (let i = 1; i <= 8; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) stepEl.classList.add('section-hidden');
            }
            
            document.getElementById(`step${step}`).classList.remove('section-hidden');

            currentStep = step;
            
            // Scroll to top of visible step
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function prefillStep4() {
            // Pre-fill Step 4 with data from previous steps if available
            if (patientData.age) {
                document.getElementById('s4-age').value = patientData.age;
            }
            if (patientData.psa) {
                document.getElementById('s4-psa').value = patientData.psa;
            }
            if (patientData.gleason) {
                document.getElementById('s4-gleason').value = patientData.gleason;
            }
            if (patientData.tStage) {
                // Map T-stage format
                const tStageMap = {
                    'T1': 'T1c',
                    'T2a': 'T2a',
                    'T2b': 'T2b',
                    'T2c': 'T2c',
                    'T3': 'T3a',
                    'T4': 'T4'
                };
                document.getElementById('s4-t-stage').value = tStageMap[patientData.tStage] || patientData.tStage;
            }
        }

        function toggleBiopsyResults() {
            const biopsyDone = document.getElementById('biopsy-done').value;
            const biopsyResults = document.getElementById('biopsy-results');
            
            if (biopsyDone === 'yes') {
                biopsyResults.classList.remove('section-hidden');
            } else {
                biopsyResults.classList.add('section-hidden');
            }
        }

        function assessPatient() {
            const age = parseInt(document.getElementById('age').value);
            const psa = parseFloat(document.getElementById('psa').value);
            const dre = document.getElementById('dre').value;
            const fitness = document.getElementById('fitness').value;
            
            const familyHistory = document.getElementById('family-history').checked;
            const brca2 = document.getElementById('brca2').checked;
            const africanCaribbean = document.getElementById('african-caribbean').checked;
            
            const luts = document.getElementById('luts').checked;
            const bonePain = document.getElementById('bone-pain').checked;
            const weightLoss = document.getElementById('weight-loss').checked;
            const fatigue = document.getElementById('fatigue').checked;

            // Validation
            if (!age || !psa || !dre || !fitness) {
                alert('Please complete all required fields');
                return;
            }

            patientData = {
                age, psa, dre, fitness,
                riskFactors: { familyHistory, brca2, africanCaribbean },
                symptoms: { luts, bonePain, weightLoss, fatigue },
                hasMetastaticSymptoms: bonePain || weightLoss || fatigue
            };

            let html = '';
            let investigations = [];
            let referralType = '';
            let pathway = '';

            // Determine referral pathway based on guidelines
            
            // Urgent referral criteria (any age)
            if (psa > 20) {
                referralType = 'urgent';
                html += `
                    <div class="alert alert-urgent">
                        <span class="alert-icon">üö®</span>
                        <div>
                            <div class="alert-title">URGENT Referral Required</div>
                            <div class="alert-text">PSA >20 ng/ml at ANY age requires urgent suspected cancer pathway referral (regardless of other factors)</div>
                        </div>
                    </div>
                `;
            }

            if (dre === 'abnormal') {
                referralType = 'urgent';
                html += `
                    <div class="alert alert-urgent">
                        <span class="alert-icon">üö®</span>
                        <div>
                            <div class="alert-title">URGENT Referral Required</div>
                            <div class="alert-text">Abnormal DRE at ANY PSA level requires urgent suspected cancer pathway referral</div>
                        </div>
                    </div>
                `;
            }

            // Age-specific pathways
            if (age >= 80) {
                // AMRC pathway for ‚â•80
                pathway = 'over80';
                if (psa > 20 || (psa > 7.5 && patientData.hasMetastaticSymptoms)) {
                    referralType = 'urgent';
                    html += `
                        <div class="alert alert-urgent">
                            <span class="alert-icon">üö®</span>
                            <div>
                                <div class="alert-title">URGENT Referral (AMRC ‚â•80 Criteria)</div>
                                <div class="alert-text">PSA >20 ng/ml OR PSA >7.5 ng/ml with metastatic symptoms (bone pain, weight loss, fatigue) requires urgent referral</div>
                            </div>
                        </div>
                    `;
                } else if (psa > 7.5) {
                    html += `
                        <div class="alert alert-warning">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <div>
                                <div class="alert-title">PSA Elevated - Monitor in Primary Care</div>
                                <div class="alert-text">PSA 7.5-20 ng/ml without metastatic symptoms: Repeat PSA in 6-8 months. Refer if rising, doubled, or symptoms develop.</div>
                            </div>
                        </div>
                    `;
                    referralType = 'monitor';
                } else {
                    html += `
                        <div class="alert alert-success">
                            <span class="alert-icon">‚úì</span>
                            <div>
                                <div class="alert-title">No Referral Indicated (AMRC Guidelines)</div>
                                <div class="alert-text">For men ‚â•80 years: Do NOT routinely test PSA unless symptomatic or life expectancy >10 years. PSA <7.5 without symptoms - monitor in primary care.</div>
                            </div>
                        </div>
                    `;
                    referralType = 'no-referral';
                }
            } else if (age >= 70) {
                // 70-79 pathway
                pathway = '70-79';
                const threshold = fitness === 'fit' ? 3 : 5;
                
                if (psa >= threshold || dre === 'abnormal') {
                    referralType = referralType || 'refer';
                    html += `
                        <div class="alert alert-info">
                            <span class="alert-icon">üìã</span>
                            <div>
                                <div class="alert-title">Referral Indicated (Age 70-79)</div>
                                <div class="alert-text">PSA ‚â•${threshold} ng/ml (${fitness === 'fit' ? 'fit patient' : 'unfit/comorbid patient'}) meets referral threshold. Consider comorbidities and life expectancy.</div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="alert alert-success">
                            <span class="alert-icon">‚úì</span>
                            <div>
                                <div class="alert-title">Below Referral Threshold</div>
                                <div class="alert-text">PSA below age-adjusted threshold. Monitor in primary care with annual PSA if clinically appropriate.</div>
                            </div>
                        </div>
                    `;
                    referralType = referralType || 'no-referral';
                }
            } else if (age >= 50) {
                // 50-69 pathway (main screening age)
                pathway = '50-69';
                if (psa >= 3 || dre === 'abnormal') {
                    referralType = referralType || 'refer';
                    html += `
                        <div class="alert alert-info">
                            <span class="alert-icon">üìã</span>
                            <div>
                                <div class="alert-title">Referral Indicated (GIRFT 2024 Standard)</div>
                                <div class="alert-text">PSA ‚â•3 ng/ml is the single threshold for men aged 50-69 (GIRFT standard). Direct to investigation pathway - no clinic appointment needed before MRI.</div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="alert alert-success">
                            <span class="alert-icon">‚úì</span>
                            <div>
                                <div class="alert-title">Below Referral Threshold</div>
                                <div class="alert-text">PSA <3 ng/ml. Not currently meeting referral criteria. Consider re-testing in 2 years if risk factors present.</div>
                            </div>
                        </div>
                    `;
                    referralType = referralType || 'no-referral';
                }
            } else {
                // Under 50
                pathway = 'under50';
                const hasRiskFactors = familyHistory || brca2 || africanCaribbean;
                
                if (hasRiskFactors && psa >= 3) {
                    referralType = referralType || 'refer';
                    html += `
                        <div class="alert alert-info">
                            <span class="alert-icon">üìã</span>
                            <div>
                                <div class="alert-title">Referral Indicated (High-Risk Under 50)</div>
                                <div class="alert-text">PSA ‚â•3 ng/ml with risk factors (family history, BRCA2, African/Caribbean ethnicity) warrants referral despite age <50.</div>
                            </div>
                        </div>
                    `;
                } else if (!hasRiskFactors) {
                    html += `
                        <div class="alert alert-warning">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <div>
                                <div class="alert-title">PSA Testing Not Generally Recommended</div>
                                <div class="alert-text">For men <50 without risk factors: PSA testing not routinely indicated. Consider testing only if strong family history, BRCA2 carrier, or African/Caribbean ethnicity.</div>
                            </div>
                        </div>
                    `;
                    referralType = 'not-indicated';
                }
            }

            // Risk factors summary
            const riskFactorList = [];
            if (familyHistory) riskFactorList.push('Family history');
            if (brca2) riskFactorList.push('BRCA2 carrier');
            if (africanCaribbean) riskFactorList.push('African/Caribbean ethnicity');
            
            if (riskFactorList.length > 0) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Risk Factors Identified</div>
                        <div class="tag-container">
                            ${riskFactorList.map(rf => `<span class="tag">${rf}</span>`).join('')}
                        </div>
                        <p style="margin-top: 12px; color: var(--text-secondary); font-size: 0.85rem;">
                            These factors increase prostate cancer risk and may influence screening/management decisions.
                        </p>
                    </div>
                `;
            }

            // Generate investigation recommendations
            html += `<div style="margin-top: 24px;"><h3 style="font-size: 1rem; margin-bottom: 16px; color: var(--accent-cyan);">Recommended Investigations</h3>`;
            
            if (referralType === 'urgent' || referralType === 'refer') {
                investigations = getInvestigations(patientData, pathway, referralType);
                html += `<div class="investigation-list">`;
                investigations.forEach(inv => {
                    html += `
                        <div class="investigation-item ${inv.priority}">
                            <div class="investigation-icon">${inv.icon}</div>
                            <div class="investigation-details">
                                <div class="investigation-name">${inv.name}</div>
                                <div class="investigation-desc">${inv.description}</div>
                            </div>
                            <span class="investigation-priority priority-${inv.priority}">${inv.priority}</span>
                        </div>
                    `;
                });
                html += `</div>`;

                // FDS timeline
                html += `
                    <div class="timeline-note">
                        <span class="timeline-icon">‚è±Ô∏è</span>
                        <div class="timeline-text">
                            <strong>28-Day Faster Diagnosis Standard:</strong> Target 77%+ patients to receive diagnosis/exclusion within 28 days of referral. 
                            One-stop clinic (MRI day 7, MDT day 14) or straight-to-test pathway recommended.
                        </div>
                    </div>
                `;
            } else if (referralType === 'monitor') {
                html += `
                    <div class="investigation-item optional">
                        <div class="investigation-icon">üîÑ</div>
                        <div class="investigation-details">
                            <div class="investigation-name">Repeat PSA</div>
                            <div class="investigation-desc">Repeat in 6-8 months. Refer if rising, doubled, or symptoms develop.</div>
                        </div>
                        <span class="investigation-priority priority-optional">Monitor</span>
                    </div>
                `;
            }

            html += `</div>`;

            document.getElementById('referral-decision').innerHTML = html;
            document.getElementById('step1-results').classList.add('visible');

            // If referral indicated, show step 2
            if (referralType === 'urgent' || referralType === 'refer') {
                document.getElementById('step2-indicator').classList.remove('section-hidden');
                patientData.pathway = pathway;
                patientData.referralType = referralType;
                
                // Scroll to results
                document.getElementById('step1-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Enable proceeding to step 2
                setTimeout(() => {
                    if (confirm('Referral criteria met. Would you like to proceed to enter investigation results?')) {
                        showStep(2);
                    }
                }, 500);
            }
        }

        function getInvestigations(data, pathway, referralType) {
            let investigations = [];
            
            if (pathway === 'over80' && referralType === 'urgent') {
                // ‚â•80 urgent pathway
                if (data.hasMetastaticSymptoms) {
                    investigations.push({
                        name: 'Bone Scan / CT Staging',
                        description: 'Assess for metastatic disease given symptomatic presentation',
                        icon: 'ü¶¥',
                        priority: 'urgent'
                    });
                    investigations.push({
                        name: 'PSA Confirmation',
                        description: 'Confirm PSA level if not already repeated',
                        icon: 'üß™',
                        priority: 'urgent'
                    });
                }
                investigations.push({
                    name: 'Consider mpMRI',
                    description: 'If fit for localised treatment (PS 0-1); otherwise symptom-based approach',
                    icon: 'üî¨',
                    priority: 'recommended'
                });
                investigations.push({
                    name: 'Biopsy if indicated',
                    description: 'LATP biopsy only if results would change management',
                    icon: 'üéØ',
                    priority: 'optional'
                });
            } else if (data.fitness === 'fit') {
                // Fit patient pathway - MRI first
                investigations.push({
                    name: 'Multiparametric MRI (mpMRI)',
                    description: 'Pre-biopsy MRI standard for all fit patients. NO clinic appointment or DRE required before MRI.',
                    icon: 'üî¨',
                    priority: 'urgent'
                });
                investigations.push({
                    name: 'Calculate PSA Density',
                    description: 'PSA √∑ prostate volume. Used with PI-RADS to guide biopsy decision.',
                    icon: 'üìä',
                    priority: 'recommended'
                });
                investigations.push({
                    name: 'LATP Biopsy (if indicated)',
                    description: 'Local anaesthetic transperineal biopsy based on MRI findings. Target lesions (max 4 cores) if PI-RADS ‚â•3.',
                    icon: 'üéØ',
                    priority: 'recommended'
                });
            } else {
                // Unfit patient pathway
                investigations.push({
                    name: 'Fitness Assessment',
                    description: 'Assess comorbidities, WHO Performance Status, life expectancy',
                    icon: '‚ù§Ô∏è',
                    priority: 'urgent'
                });
                investigations.push({
                    name: 'Consider mpMRI',
                    description: 'Based on whether results would change management',
                    icon: 'üî¨',
                    priority: 'optional'
                });
            }

            // Add staging investigations for very high PSA
            if (data.psa > 20) {
                investigations.push({
                    name: 'Staging Investigations',
                    description: 'Consider PSMA PET-CT or bone scan + CT for metastatic staging',
                    icon: 'üîç',
                    priority: 'recommended'
                });
            }

            return investigations;
        }

        function processInvestigations() {
            const pirads = document.getElementById('pirads').value;
            const volume = document.getElementById('prostate-volume').value;
            const biopsyDone = document.getElementById('biopsy-done').value;
            const gleason = document.getElementById('gleason').value;
            const tStage = document.getElementById('t-stage').value;

            calculatePSAD();

            let html = '';

            // MRI-based recommendations
            if (pirads && volume) {
                const psad = patientData.psad;
                html += getMRIRecommendation(parseInt(pirads), psad);
            }

            // If biopsy positive, proceed to CPG
            if (biopsyDone === 'yes') {
                if (!gleason || !tStage) {
                    alert('Please enter Grade Group and T-Stage for cancer-positive biopsy');
                    return;
                }
                
                const cpg = calculateCPG(parseInt(gleason), patientData.psa, tStage);
                patientData.cpg = cpg;
                patientData.gleason = parseInt(gleason);
                patientData.tStage = tStage;
                
                // Show MRI results first
                document.getElementById('mri-recommendation').innerHTML = html;
                document.getElementById('step2-results').classList.add('visible');
                
                // Mark step 2 complete and show step 3
                document.getElementById('step2-indicator').classList.add('completed');
                document.getElementById('step3-indicator').classList.add('active');
                document.getElementById('step3').classList.remove('section-hidden');
                
                // Display CPG results
                displayCPGResult(cpg);
                
                // Scroll to step 3
                setTimeout(() => {
                    document.getElementById('step3').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
                
            } else if (biopsyDone === 'negative') {
                html += `
                    <div class="alert alert-success" style="margin-top: 20px;">
                        <span class="alert-icon">‚úì</span>
                        <div>
                            <div class="alert-title">Biopsy Negative for Cancer</div>
                            <div class="alert-text">
                                <p><strong>If PI-RADS 4-5:</strong> Review at MDT - consider re-biopsy</p>
                                <p><strong>If PI-RADS 1-3:</strong> Discharge to GP with PSAD-based re-referral threshold</p>
                            </div>
                        </div>
                    </div>
                `;
                
                html += getNegativeBiopsyManagement(parseInt(pirads), patientData.psad);
                document.getElementById('mri-recommendation').innerHTML = html;
                document.getElementById('step2-results').classList.add('visible');
                
            } else if (biopsyDone === 'no') {
                // No biopsy yet - show recommendations
                if (pirads) {
                    const needsBiopsy = checkBiopsyIndication(parseInt(pirads), patientData.psad);
                    if (needsBiopsy.recommended) {
                        html += `
                            <div class="alert alert-warning" style="margin-top: 20px;">
                                <span class="alert-icon">‚ö†Ô∏è</span>
                                <div>
                                    <div class="alert-title">Biopsy Recommended</div>
                                    <div class="alert-text">${needsBiopsy.reason}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="alert alert-success" style="margin-top: 20px;">
                                <span class="alert-icon">‚úì</span>
                                <div>
                                    <div class="alert-title">Biopsy May Not Be Required</div>
                                    <div class="alert-text">Based on PI-RADS ${pirads} and PSAD ${patientData.psad ? patientData.psad.toFixed(3) : 'N/A'}, biopsy may not be indicated. Consider discharge to GP with re-referral threshold or surveillance.</div>
                                </div>
                            </div>
                        `;
                    }
                }
                document.getElementById('mri-recommendation').innerHTML = html;
                document.getElementById('step2-results').classList.add('visible');
            } else {
                // No biopsy selection made
                document.getElementById('mri-recommendation').innerHTML = html;
                document.getElementById('step2-results').classList.add('visible');
            }
        }
        
        function getNegativeBiopsyManagement(pirads, psad) {
            let html = `
                <div class="management-section" style="margin-top: 20px;">
                    <div class="management-title">Recommended Follow-up (Negative Biopsy)</div>
                    <ul class="management-list">
            `;
            
            if (pirads >= 4) {
                html += `
                    <li>MDT review recommended - consider re-biopsy or targeted repeat</li>
                    <li>Repeat MRI in 12 months if not re-biopsied</li>
                    <li>Continue PSA monitoring every 3-6 months</li>
                `;
            } else if (pirads === 3) {
                html += `
                    <li>Consider repeat MRI in 12 months</li>
                    <li>PSA monitoring every 6 months</li>
                    <li>Re-refer if PSA rises significantly or symptoms develop</li>
                `;
            } else {
                html += `
                    <li>Discharge to GP with safety-netting advice</li>
                    <li>Re-referral threshold: PSA doubling or increase >0.75 ng/ml/year</li>
                    <li>Annual PSA in primary care if clinically appropriate</li>
                `;
            }
            
            html += `
                    </ul>
                </div>
            `;
            return html;
        }

        function getMRIRecommendation(pirads, psad) {
            let html = '<div class="investigation-list">';
            let recommendation = '';
            let alertType = 'info';

            if (pirads <= 2) {
                if (psad < 0.12) {
                    recommendation = 'No biopsy recommended. Discharge to GP with re-referral threshold (PSA doubling or >0.11 increase).';
                    alertType = 'success';
                } else if (psad <= 0.20) {
                    recommendation = 'Discuss biopsy (shared decision). Risk of clinically significant cancer 5-15%.';
                    alertType = 'warning';
                } else {
                    recommendation = 'Recommend biopsy despite low PI-RADS due to elevated PSAD (>0.20).';
                    alertType = 'warning';
                }
            } else if (pirads === 3) {
                if (psad < 0.12) {
                    recommendation = 'No biopsy recommended. Consider repeat PSA/MRI in 3-6 months.';
                    alertType = 'info';
                } else if (psad <= 0.15) {
                    recommendation = 'Discuss biopsy (shared decision). Risk of clinically significant cancer 15-25%.';
                    alertType = 'warning';
                } else {
                    recommendation = 'Recommend biopsy. PSAD >0.15 with PI-RADS 3 indicates >25% risk of significant cancer.';
                    alertType = 'warning';
                }
            } else {
                recommendation = 'Biopsy strongly recommended. PI-RADS 4-5 indicates >50% risk of clinically significant cancer.';
                alertType = 'urgent';
            }

            html += `
                <div class="alert alert-${alertType === 'urgent' ? 'urgent' : alertType}">
                    <span class="alert-icon">${alertType === 'success' ? '‚úì' : alertType === 'urgent' ? 'üö®' : 'üìã'}</span>
                    <div>
                        <div class="alert-title">PI-RADS ${pirads} | PSAD ${psad ? psad.toFixed(3) : 'N/A'}</div>
                        <div class="alert-text">${recommendation}</div>
                    </div>
                </div>
            `;

            // Add PSAD calculation reference
            html += `
                <div class="info-box">
                    <div class="info-box-title">PSAD Reference Table (PI-RADS 1-2)</div>
                    <table style="width: 100%; margin-top: 12px; font-size: 0.85rem;">
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 8px 0;"><strong>PSAD <0.12</strong></td>
                            <td>No biopsy - <5% risk</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 8px 0;"><strong>PSAD 0.12-0.20</strong></td>
                            <td>Discuss biopsy - 5-15% risk</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0;"><strong>PSAD >0.20</strong></td>
                            <td>Recommend biopsy - >15% risk</td>
                        </tr>
                    </table>
                </div>
            `;

            html += '</div>';
            return html;
        }

        function checkBiopsyIndication(pirads, psad) {
            if (pirads >= 4) {
                return { recommended: true, reason: 'PI-RADS 4-5 - biopsy strongly recommended (>50% risk of csPCa)' };
            }
            if (pirads === 3 && psad > 0.15) {
                return { recommended: true, reason: 'PI-RADS 3 with PSAD >0.15 - biopsy recommended (>25% risk)' };
            }
            if (pirads <= 2 && psad > 0.20) {
                return { recommended: true, reason: 'PSAD >0.20 despite low PI-RADS - consider biopsy' };
            }
            return { recommended: false };
        }

        function calculateCPG(gradeGroup, psa, tStage) {
            // Cambridge Prognostic Group calculation
            const isT3orHigher = tStage === 'T3' || tStage === 'T4';
            const isT4 = tStage === 'T4';

            // CPG 5: Any combination of GG ‚â•4 + PSA >20 + T3, OR GG5, OR T4
            if (gradeGroup === 5 || isT4 || (gradeGroup >= 4 && psa > 20 && isT3orHigher)) {
                return 5;
            }

            // CPG 4: GG4 OR PSA >20 OR T3
            if (gradeGroup === 4 || psa > 20 || isT3orHigher) {
                return 4;
            }

            // CPG 3: GG3 (4+3) OR (GG2 AND PSA 10-20)
            if (gradeGroup === 3 || (gradeGroup === 2 && psa >= 10 && psa <= 20)) {
                return 3;
            }

            // CPG 2: GG2 (3+4) with PSA <10
            if (gradeGroup === 2 && psa < 10) {
                return 2;
            }

            // CPG 1: GG1, PSA <10, T1-T2
            if (gradeGroup === 1 && psa < 10 && !isT3orHigher) {
                return 1;
            }

            return 1; // Default to lowest risk if unclear
        }

        function displayCPGResult(cpg) {
            let html = '';

            // CPG selection display
            html += `
                <div class="cpg-grid">
                    <div class="cpg-card cpg-1 ${cpg === 1 ? 'selected' : ''}" style="opacity: ${cpg === 1 ? 1 : 0.5}">
                        <div class="cpg-number">1</div>
                        <div class="cpg-label">Low Risk</div>
                    </div>
                    <div class="cpg-card cpg-2 ${cpg === 2 ? 'selected' : ''}" style="opacity: ${cpg === 2 ? 1 : 0.5}">
                        <div class="cpg-number">2</div>
                        <div class="cpg-label">Favourable</div>
                    </div>
                    <div class="cpg-card cpg-3 ${cpg === 3 ? 'selected' : ''}" style="opacity: ${cpg === 3 ? 1 : 0.5}">
                        <div class="cpg-number">3</div>
                        <div class="cpg-label">Intermediate</div>
                    </div>
                    <div class="cpg-card cpg-4 ${cpg === 4 ? 'selected' : ''}" style="opacity: ${cpg === 4 ? 1 : 0.5}">
                        <div class="cpg-number">4</div>
                        <div class="cpg-label">High Risk</div>
                    </div>
                    <div class="cpg-card cpg-5 ${cpg === 5 ? 'selected' : ''}" style="opacity: ${cpg === 5 ? 1 : 0.5}">
                        <div class="cpg-number">5</div>
                        <div class="cpg-label">Very High</div>
                    </div>
                </div>
            `;

            // Get management recommendations
            const management = getCPGManagement(cpg);

            html += `
                <div class="alert ${management.alertClass}">
                    <span class="alert-icon">${management.icon}</span>
                    <div>
                        <div class="alert-title">Cambridge Prognostic Group ${cpg}: ${management.title}</div>
                        <div class="alert-text">${management.summary}</div>
                    </div>
                </div>
            `;

            // Criteria display
            html += `
                <div class="info-box">
                    <div class="info-box-title">CPG ${cpg} Criteria Met</div>
                    <div class="tag-container">
                        <span class="tag">Grade Group ${patientData.gleason}</span>
                        <span class="tag">PSA ${patientData.psa} ng/ml</span>
                        <span class="tag">Stage ${patientData.tStage}</span>
                    </div>
                </div>
            `;

            // Management recommendations
            html += `
                <div class="management-section">
                    <div class="management-title">${management.managementTitle}</div>
                    <ul class="management-list">
                        ${management.recommendations.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
            `;

            // Follow-up
            html += `
                <div class="management-section">
                    <div class="management-title">Follow-up & Monitoring</div>
                    <ul class="management-list">
                        ${management.followUp.map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>
            `;

            // Timeline
            html += `
                <div class="timeline-note">
                    <span class="timeline-icon">${management.timelineIcon}</span>
                    <div class="timeline-text">
                        <strong>Treatment Timeline:</strong> ${management.timeline}
                    </div>
                </div>
            `;

            // MDT note
            html += `
                <div class="alert alert-info" style="margin-top: 20px;">
                    <span class="alert-icon">üë•</span>
                    <div>
                        <div class="alert-title">MDT Discussion Required</div>
                        <div class="alert-text">All diagnoses must be discussed at Multidisciplinary Team meeting. Members: Urology, Oncology, Radiology, Pathology, CNS/Patient representative.</div>
                    </div>
                </div>
            `;

            // Resources
            html += `
                <div class="info-box" style="margin-top: 20px;">
                    <div class="info-box-title">Clinical Tools & Resources</div>
                    <ul style="margin-top: 12px; list-style: none;">
                        <li style="margin-bottom: 8px;">üìä <a href="https://cambridgeprognosticgroup.com" target="_blank" style="color: var(--accent-cyan);">Cambridge Prognostic Group Calculator</a></li>
                        <li style="margin-bottom: 8px;">üìà <a href="https://www.predict.nhs.uk/prostate" target="_blank" style="color: var(--accent-cyan);">Predict Prostate (NICE Endorsed)</a></li>
                        <li>‚è±Ô∏è <a href="https://www.ons.gov.uk/" target="_blank" style="color: var(--accent-cyan);">ONS Life Expectancy Calculator</a></li>
                    </ul>
                </div>
            `;

            // Navigation buttons
            html += `
                <div class="btn-group" style="margin-top: 24px;">
                    <button class="btn btn-primary" onclick="showStep(4)">
                        <span>Proceed to Full Risk & Prognosis</span>
                        <span>‚Üí</span>
                    </button>
                    <button class="btn btn-secondary" onclick="showStep(5)">
                        <span>ü©∫ Clinical Diagnosis (No Biopsy)</span>
                    </button>
                </div>
            `;

            document.getElementById('cpg-result').innerHTML = html;
        }

        function getCPGManagement(cpg) {
            const management = {
                1: {
                    alertClass: 'alert-success',
                    icon: '‚úì',
                    title: 'Low Risk',
                    summary: 'GG1 (Gleason 6), PSA <10, T1-T2. Excellent prognosis with active surveillance.',
                    managementTitle: 'Active Surveillance Recommended',
                    recommendations: [
                        'Active surveillance is standard of care (not "watchful waiting")',
                        'PSA every 3 months in year 1, then every 6 months',
                        'Repeat MRI at 12 months',
                        'No routine DRE required',
                        'Patient Initiated Follow-Up (PIFU) available',
                        'Radical treatment only if progression'
                    ],
                    followUp: [
                        'Year 1: PSA every 3 months',
                        'Year 2+: PSA every 6 months',
                        'MRI at 12 months, then as indicated',
                        'Re-biopsy only if clinical/radiological progression',
                        'Discuss PIFU eligibility'
                    ],
                    timeline: 'No urgent treatment required. Review at 12 months.',
                    timelineIcon: 'üìÖ'
                },
                2: {
                    alertClass: 'alert-info',
                    icon: 'üìã',
                    title: 'Favourable Intermediate Risk',
                    summary: 'GG2 (Gleason 3+4) OR PSA 10-20 OR T2b. Good prognosis - AS appropriate for selected patients.',
                    managementTitle: 'Active Surveillance or Treatment Discussion',
                    recommendations: [
                        'Active surveillance appropriate for selected patients',
                        'Particularly if: small volume, non-MRI visible, older patient',
                        'If treatment preferred: Radical prostatectomy OR Radiotherapy',
                        'Use Predict Prostate tool for shared decision-making',
                        'Consider patient preferences and life expectancy'
                    ],
                    followUp: [
                        'If AS: PSA every 3 months year 1, MRI at 12 months',
                        'Closer monitoring than CPG 1',
                        'Treatment if progression (PSA velocity, MRI changes, re-biopsy upgrade)',
                        'Review in 2-4 weeks for treatment decision'
                    ],
                    timeline: 'Discuss options within 2-4 weeks. No immediate treatment urgency.',
                    timelineIcon: 'üìÖ'
                },
                3: {
                    alertClass: 'alert-warning',
                    icon: '‚ö†Ô∏è',
                    title: 'Unfavourable Intermediate Risk',
                    summary: 'GG3 (Gleason 4+3) OR GG2 with PSA 10-20. Consider active treatment.',
                    managementTitle: 'Active Treatment Usually Recommended',
                    recommendations: [
                        'Active treatment generally recommended',
                        'Active surveillance only for highly selected cases (non-MRI visible GG2)',
                        'Treatment options: Radical prostatectomy OR Radiotherapy ¬± short-term ADT',
                        'Shared decision-making essential',
                        'Use Predict Prostate for treatment discussions',
                        'Consider clinical trials'
                    ],
                    followUp: [
                        'Review in 2-4 weeks with treatment plan',
                        'Staging if not already complete',
                        'Joint oncology-urology clinic ideal',
                        'If AS chosen: very close monitoring required'
                    ],
                    timeline: 'Treatment decision within 2-4 weeks. Treatment within 6-8 weeks.',
                    timelineIcon: '‚è±Ô∏è'
                },
                4: {
                    alertClass: 'alert-urgent',
                    icon: 'üö®',
                    title: 'High Risk',
                    summary: 'GG4 (Gleason 8) OR PSA >20 OR T3. Active treatment urgently required.',
                    managementTitle: 'Active Treatment Required',
                    recommendations: [
                        'Active treatment required - NOT suitable for surveillance',
                        'Complete staging: Consider PSMA PET-CT',
                        'Treatment options: Radical prostatectomy (if operable) OR Radiotherapy + ADT',
                        'If radiotherapy: 2-3 years ADT recommended',
                        'Consider clinical trials for intensification',
                        'Joint oncology-urology clinic review'
                    ],
                    followUp: [
                        'Urgent review within 2-4 weeks',
                        'Complete staging before treatment decision',
                        'MDT discussion mandatory',
                        'Treatment initiation within 4-6 weeks'
                    ],
                    timeline: 'Urgent review within 2 weeks. Treatment within 4-6 weeks.',
                    timelineIcon: 'üö®'
                },
                5: {
                    alertClass: 'alert-urgent',
                    icon: 'üö®',
                    title: 'Very High Risk',
                    summary: 'GG5 OR multiple high-risk features (GG4+PSA>20+T3) OR T4. Urgent treatment within 1 month.',
                    managementTitle: 'URGENT Active Treatment Required',
                    recommendations: [
                        'TREAT WITHIN 1 MONTH - urgent pathway',
                        'Complete staging URGENTLY (PSMA PET-CT preferred)',
                        'Radiotherapy + long-term ADT (2-3 years) typically recommended',
                        'Surgery if operable and patient preference',
                        'Consider treatment intensification (docetaxel, abiraterone)',
                        'Palliative input if metastatic at diagnosis'
                    ],
                    followUp: [
                        'Urgent staging within 1-2 weeks',
                        'Treatment initiation within 1 month maximum',
                        'MDT discussion priority listing',
                        'Consider early oncology involvement'
                    ],
                    timeline: 'TREAT WITHIN 1 MONTH. Priority MDT discussion.',
                    timelineIcon: 'üö®'
                }
            };

            return management[cpg];
        }

        function resetForm() {
            document.getElementById('age').value = '';
            document.getElementById('psa').value = '';
            document.getElementById('dre').value = '';
            document.getElementById('fitness').value = '';
            document.getElementById('family-history').checked = false;
            document.getElementById('brca2').checked = false;
            document.getElementById('african-caribbean').checked = false;
            document.getElementById('luts').checked = false;
            document.getElementById('bone-pain').checked = false;
            document.getElementById('weight-loss').checked = false;
            document.getElementById('fatigue').checked = false;
            document.getElementById('pirads').value = '';
            document.getElementById('prostate-volume').value = '';
            document.getElementById('psad').value = '';
            document.getElementById('biopsy-done').value = '';
            document.getElementById('gleason').value = '';
            document.getElementById('t-stage').value = '';

            document.getElementById('step1-results').classList.remove('visible');
            document.getElementById('step2-results').classList.remove('visible');
            document.getElementById('biopsy-results').classList.add('section-hidden');
            document.getElementById('step4-results').classList.remove('visible');
            document.getElementById('step5-results').classList.remove('visible');

            patientData = {};
            showStep(1);

            // Reset step indicators
            for (let i = 1; i <= 8; i++) {
                const el = document.getElementById(`step${i}-indicator`);
                if (el) el.classList.remove('completed');
            }
        }
        
        function resetStep1() {
            document.getElementById('age').value = '';
            document.getElementById('psa').value = '';
            document.getElementById('dre').value = '';
            document.getElementById('fitness').value = '';
            document.getElementById('family-history').checked = false;
            document.getElementById('brca2').checked = false;
            document.getElementById('african-caribbean').checked = false;
            document.getElementById('luts').checked = false;
            document.getElementById('bone-pain').checked = false;
            document.getElementById('weight-loss').checked = false;
            document.getElementById('fatigue').checked = false;
            document.getElementById('step1-results').classList.remove('visible');
            document.getElementById('referral-decision').innerHTML = '';
        }
        
        function resetStep2() {
            document.getElementById('s2-psa').value = '';
            document.getElementById('pirads').value = '';
            document.getElementById('prostate-volume').value = '';
            document.getElementById('psad').value = '';
            document.getElementById('biopsy-done').value = '';
            document.getElementById('gleason').value = '';
            document.getElementById('t-stage').value = '';
            document.getElementById('biopsy-results').classList.add('section-hidden');
            document.getElementById('step2-results').classList.remove('visible');
            document.getElementById('mri-recommendation').innerHTML = '';
        }
        
        function resetStep3() {
            document.getElementById('quick-psa').value = '';
            document.getElementById('quick-gleason').value = '';
            document.getElementById('quick-tstage').value = '';
            document.getElementById('cpg-result').innerHTML = '';
        }
        
        function resetStep4() {
            const fields = ['s4-age', 's4-performance', 's4-life-expectancy', 's4-comorbidities', 's4-psa', 
                's4-psa-velocity', 's4-psa-doubling', 's4-gleason', 's4-cores-positive', 's4-max-core',
                's4-dre', 's4-pirads', 's4-prostate-volume', 's4-lesion-size', 's4-epe', 's4-svi', 
                's4-lymph-mri', 's4-t-stage', 's4-n-stage', 's4-m-stage', 's4-bone-scan', 
                's4-ct-cap', 's4-psma-pet'];
            
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            ['s4-perineural', 's4-lymphovascular', 's4-cribriform', 's4-intraductal', 's4-brca'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = false;
            });
            
            document.getElementById('step4-results').classList.remove('visible');
            document.getElementById('comprehensive-results').innerHTML = '';
        }
        
        function resetStep5() {
            document.getElementById('s5-risk-group').value = '';
            document.getElementById('s5-age').value = '';
            document.getElementById('s5-life-expectancy').value = '';
            document.getElementById('s5-treatment').value = '';
            document.getElementById('treatment-details').innerHTML = '';
        }
        
        function resetStep6() {
            document.getElementById('s6-treatment').value = '';
            document.getElementById('s6-treatment-date').value = '';
            document.getElementById('s6-risk-group').value = '';
            document.getElementById('s6-age').value = '';
            document.getElementById('s6-psa-nadir').value = '';
            document.getElementById('s6-margins').value = '';
            document.getElementById('followup-schedule').innerHTML = '';
        }
        
        function resetStep7() {
            document.getElementById('s7-initial-treatment').value = '';
            document.getElementById('s7-treatment-date').value = '';
            document.getElementById('s7-age').value = '';
            document.getElementById('s7-psa-nadir').value = '';
            document.getElementById('s7-current-psa').value = '';
            document.getElementById('s7-psa-doubling').value = '';
            document.getElementById('s7-original-gleason').value = '';
            document.getElementById('s7-progression-type').value = '';
            document.getElementById('s7-asymptomatic').checked = false;
            document.getElementById('s7-bone-pain').checked = false;
            document.getElementById('s7-luts').checked = false;
            document.getElementById('s7-fatigue').checked = false;
            document.getElementById('progression-management').innerHTML = '';
        }
        
        function resetStep8() {
            resetClinicalDiagnosis();
        }
        
        function resetAll() {
            // Confirm before resetting
            if (!confirm('Clear all data and start fresh for a new patient?')) {
                return;
            }
            
            // Reset all steps
            resetStep1();
            resetStep2();
            resetStep3();
            resetStep4();
            resetStep5();
            resetStep6();
            resetStep7();
            resetStep8();
            
            // Hide all results panels
            document.getElementById('step1-results').classList.remove('visible');
            document.getElementById('step2-results').classList.remove('visible');
            document.getElementById('step4-results').classList.remove('visible');
            document.getElementById('step8-results').classList.remove('visible');
            
            // Clear result content
            document.getElementById('referral-decision').innerHTML = '';
            document.getElementById('mri-recommendation').innerHTML = '';
            document.getElementById('cpg-result').innerHTML = '';
            document.getElementById('clinical-diagnosis-output').innerHTML = '';
            document.getElementById('treatment-details').innerHTML = '';
            document.getElementById('followup-schedule').innerHTML = '';
            document.getElementById('progression-management').innerHTML = '';
            
            // Reset patient data
            patientData = {};
            
            // Reset to Step 1
            showStep(1);
            
            // Reset all step indicators
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`step${i}-indicator`).classList.remove('completed', 'active');
            }
            document.getElementById('step1-indicator').classList.add('active');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function calculateQuickCPG() {
            const psa = parseFloat(document.getElementById('quick-psa').value);
            const gleason = document.getElementById('quick-gleason').value;
            const tStage = document.getElementById('quick-tstage').value;
            
            if (!psa || !gleason || !tStage) {
                alert('Please complete all fields to calculate CPG');
                return;
            }
            
            patientData.psa = psa;
            patientData.gleason = parseInt(gleason);
            patientData.tStage = tStage;
            
            const cpg = calculateCPG(parseInt(gleason), psa, tStage);
            patientData.cpg = cpg;
            
            // Display CPG results in step 3
            displayCPGResult(cpg);
            
            // Scroll to results
            setTimeout(() => {
                document.getElementById('cpg-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }
        
        function toggleQuickCPG() {
            const quickCPG = document.getElementById('quick-cpg');
            const clinicalDiag = document.getElementById('clinical-diagnosis');
            clinicalDiag.classList.add('section-hidden');
            quickCPG.classList.toggle('section-hidden');
            if (!quickCPG.classList.contains('section-hidden')) {
                quickCPG.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function toggleClinicalDiagnosis() {
            const clinicalDiag = document.getElementById('clinical-diagnosis');
            const quickCPG = document.getElementById('quick-cpg');
            quickCPG.classList.add('section-hidden');
            clinicalDiag.classList.toggle('section-hidden');
            if (!clinicalDiag.classList.contains('section-hidden')) {
                clinicalDiag.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function resetClinicalDiagnosis() {
            const fields = ['cd-age', 'cd-performance', 'cd-life-expectancy', 'cd-frailty', 'cd-psa', 
                'cd-psa-trend', 'cd-dre', 'cd-clinical-t', 'cd-mri', 'cd-bone-scan', 'cd-ct', 'cd-psma'];
            
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            const checkboxes = ['cd-luts', 'cd-retention', 'cd-haematuria', 'cd-bone-pain', 'cd-back-pain',
                'cd-weight-loss', 'cd-fatigue', 'cd-anaemia', 'cd-cord-compression', 'cd-reason-frailty',
                'cd-reason-metastatic', 'cd-reason-psa', 'cd-reason-life-expectancy', 'cd-reason-patient-choice',
                'cd-reason-anticoag'];
            
            checkboxes.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = false;
            });
            
            document.getElementById('step5-results').classList.remove('visible');
            document.getElementById('clinical-diagnosis-output').innerHTML = '';
        }
        
        function calculateClinicalDiagnosis() {
            // Gather data
            const data = {
                age: parseInt(document.getElementById('cd-age').value),
                performance: document.getElementById('cd-performance').value,
                lifeExpectancy: document.getElementById('cd-life-expectancy').value,
                frailty: document.getElementById('cd-frailty').value,
                psa: parseFloat(document.getElementById('cd-psa').value),
                psaTrend: document.getElementById('cd-psa-trend').value,
                dre: document.getElementById('cd-dre').value,
                clinicalT: document.getElementById('cd-clinical-t').value,
                mri: document.getElementById('cd-mri').value,
                boneScan: document.getElementById('cd-bone-scan').value,
                ct: document.getElementById('cd-ct').value,
                psma: document.getElementById('cd-psma').value,
                // Symptoms
                luts: document.getElementById('cd-luts').checked,
                retention: document.getElementById('cd-retention').checked,
                haematuria: document.getElementById('cd-haematuria').checked,
                bonePain: document.getElementById('cd-bone-pain').checked,
                backPain: document.getElementById('cd-back-pain').checked,
                weightLoss: document.getElementById('cd-weight-loss').checked,
                fatigue: document.getElementById('cd-fatigue').checked,
                anaemia: document.getElementById('cd-anaemia').checked,
                cordCompression: document.getElementById('cd-cord-compression').checked,
                // Reasons for no biopsy
                reasonFrailty: document.getElementById('cd-reason-frailty').checked,
                reasonMetastatic: document.getElementById('cd-reason-metastatic').checked,
                reasonPsa: document.getElementById('cd-reason-psa').checked,
                reasonLifeExpectancy: document.getElementById('cd-reason-life-expectancy').checked,
                reasonPatientChoice: document.getElementById('cd-reason-patient-choice').checked,
                reasonAnticoag: document.getElementById('cd-reason-anticoag').checked
            };
            
            // Validation
            if (!data.psa) {
                alert('Please enter at least the PSA level');
                return;
            }
            
            // Determine disease extent
            const diseaseExtent = determineDiseaseExtent(data);
            
            // Generate management recommendations
            const management = generateClinicalManagement(data, diseaseExtent);
            
            // Display results
            displayClinicalDiagnosisResults(data, diseaseExtent, management);
        }
        
        function determineDiseaseExtent(data) {
            let extent = {
                category: '',
                isMetastatic: false,
                metastaticSites: [],
                isLocallyAdvanced: false,
                isHighVolume: false,
                hasVisceralMets: false,
                hasCordCompression: false,
                clinicalStage: ''
            };
            
            // Check for metastatic disease
            if (data.boneScan === 'positive-limited' || data.boneScan === 'positive-extensive' || 
                data.boneScan === 'superscan' || data.ct === 'visceral' || data.ct === 'nodes-distant' ||
                data.psma === 'oligomet' || data.psma === 'polymet' || data.psma === 'widespread') {
                extent.isMetastatic = true;
                extent.category = 'Metastatic';
                
                // Determine metastatic sites
                if (data.boneScan === 'positive-limited' || data.boneScan === 'positive-extensive' || 
                    data.boneScan === 'superscan' || data.ct === 'bone-lesions') {
                    extent.metastaticSites.push('Bone');
                }
                if (data.ct === 'nodes-distant' || data.psma === 'nodal') {
                    extent.metastaticSites.push('Distant lymph nodes');
                }
                if (data.ct === 'visceral') {
                    extent.metastaticSites.push('Visceral organs');
                    extent.hasVisceralMets = true;
                }
                
                // High volume assessment (CHAARTED criteria)
                if (data.boneScan === 'positive-extensive' || data.boneScan === 'superscan' ||
                    data.psma === 'polymet' || data.psma === 'widespread' || extent.hasVisceralMets) {
                    extent.isHighVolume = true;
                }
                
                extent.clinicalStage = 'cM1';
            } else if (data.clinicalT === 'T3' || data.clinicalT === 'T4' || 
                       data.ct === 'nodes-pelvic' || data.mri === 'local-advanced' || data.mri === 'node-positive') {
                extent.isLocallyAdvanced = true;
                extent.category = 'Locally Advanced';
                extent.clinicalStage = data.clinicalT === 'T4' ? 'cT4N0-1M0' : 'cT3N0-1M0';
            } else {
                extent.category = 'Presumed Localised (High Risk)';
                extent.clinicalStage = 'cT1-2N0M0';
            }
            
            // Cord compression check
            if (data.cordCompression || data.backPain) {
                extent.hasCordCompression = data.cordCompression;
            }
            
            return extent;
        }
        
        function generateClinicalManagement(data, extent) {
            let management = {
                urgentActions: [],
                primaryTreatment: [],
                supportiveCare: [],
                monitoring: [],
                considerations: [],
                notRecommended: [],
                prognosis: {}
            };
            
            // URGENT ACTIONS
            if (extent.hasCordCompression || data.cordCompression) {
                management.urgentActions.push({
                    action: 'URGENT MRI Whole Spine',
                    detail: 'Suspected metastatic spinal cord compression (MSCC) - requires urgent imaging within 24 hours',
                    evidence: 'NICE CG75 / NG131'
                });
                management.urgentActions.push({
                    action: 'Contact MSCC Coordinator',
                    detail: 'Immediate dexamethasone 16mg, urgent oncology/neurosurgical review',
                    evidence: 'NICE CG75'
                });
            }
            
            if (data.retention) {
                management.urgentActions.push({
                    action: 'Manage Urinary Retention',
                    detail: 'Catheterisation, consider starting alpha-blocker or ADT for decompression',
                    evidence: 'NICE NG131'
                });
            }
            
            // PRIMARY TREATMENT based on extent and fitness
            if (extent.isMetastatic) {
                // Metastatic disease management
                if (data.performance <= 2 && (data.lifeExpectancy !== 'less1')) {
                    management.primaryTreatment.push({
                        name: 'Androgen Deprivation Therapy (ADT)',
                        detail: 'LHRH agonist (with anti-androgen cover for flare) OR LHRH antagonist OR bilateral orchidectomy',
                        evidence: 'NICE NG131, EAU 2024 - Standard first-line for mHSPC'
                    });
                    
                    if (data.performance <= 1 && data.frailty !== 'severe') {
                        management.primaryTreatment.push({
                            name: 'ADT + Novel Hormonal Agent',
                            detail: 'Add Abiraterone (+ prednisolone), Enzalutamide, Apalutamide, or Darolutamide to ADT',
                            evidence: 'NICE NG131, EAU 2024 - Improves survival vs ADT alone'
                        });
                        
                        if (extent.isHighVolume && data.performance === 0) {
                            management.considerations.push('Consider triplet therapy (ADT + docetaxel + novel agent) if fit enough - discuss with oncology');
                        }
                    }
                    
                    if (!extent.isHighVolume) {
                        management.considerations.push('Low-volume metastatic disease - consider radiotherapy to primary tumour in addition to systemic therapy (STAMPEDE evidence)');
                    }
                } else {
                    // Frail/poor prognosis
                    management.primaryTreatment.push({
                        name: 'ADT Monotherapy',
                        detail: 'LHRH antagonist preferred (no flare) OR bilateral orchidectomy (immediate effect, one procedure)',
                        evidence: 'Appropriate for frail patients - avoids combination therapy toxicity'
                    });
                    management.primaryTreatment.push({
                        name: 'Consider Watchful Waiting',
                        detail: 'Symptom-directed management if very limited life expectancy and asymptomatic',
                        evidence: 'NICE NG131 - Valid option in selected cases'
                    });
                }
                
                // Bone protection
                if (extent.metastaticSites.includes('Bone')) {
                    management.supportiveCare.push({
                        name: 'Bone-Targeted Therapy',
                        detail: 'Denosumab or Zoledronic acid to reduce skeletal-related events. Check calcium, vitamin D, dental health first.',
                        evidence: 'NICE NG131, EAU 2024'
                    });
                }
                
                // Prognosis for metastatic
                if (extent.isHighVolume || extent.hasVisceralMets) {
                    management.prognosis = {
                        summary: 'High-volume/visceral metastatic disease',
                        median: 'Median survival 3-4 years with optimal combination therapy',
                        fiveYear: '30-40%'
                    };
                } else {
                    management.prognosis = {
                        summary: 'Low-volume metastatic disease',
                        median: 'Median survival 4-6 years with optimal treatment',
                        fiveYear: '50-60%'
                    };
                }
                
            } else if (extent.isLocallyAdvanced) {
                // Locally advanced disease
                if (data.performance <= 1 && data.lifeExpectancy !== 'less1' && data.lifeExpectancy !== '1-2') {
                    management.primaryTreatment.push({
                        name: 'Radiotherapy + Long-term ADT',
                        detail: 'External beam radiotherapy with 2-3 years of ADT',
                        evidence: 'NICE NG131, EAU 2024 - Standard for locally advanced'
                    });
                    management.considerations.push('If histology required for treatment planning, consider targeted biopsy under sedation/GA if patient agreeable');
                } else {
                    management.primaryTreatment.push({
                        name: 'ADT Alone',
                        detail: 'LHRH agonist/antagonist or orchidectomy - appropriate for frail patients with locally advanced disease',
                        evidence: 'NICE NG131'
                    });
                    management.primaryTreatment.push({
                        name: 'Watchful Waiting',
                        detail: 'Monitor symptoms, start treatment when symptomatic',
                        evidence: 'Valid for limited life expectancy'
                    });
                }
                
                management.prognosis = {
                    summary: 'Locally advanced disease (clinical diagnosis)',
                    median: 'Highly variable - depends on treatment and response',
                    fiveYear: '70-85% with optimal treatment'
                };
                
            } else {
                // Presumed localised but high-risk (high PSA, abnormal DRE, no biopsy)
                management.primaryTreatment.push({
                    name: 'Consider Biopsy if Feasible',
                    detail: 'Histological diagnosis preferred if patient fitness improves or circumstances change',
                    evidence: 'NICE NG131'
                });
                management.primaryTreatment.push({
                    name: 'Active Monitoring',
                    detail: 'Regular PSA monitoring, treat if symptoms develop or PSA rises significantly',
                    evidence: 'Appropriate for asymptomatic patients with limited life expectancy'
                });
                management.primaryTreatment.push({
                    name: 'ADT if Symptomatic',
                    detail: 'Start ADT if symptoms develop or PSA shows rapid rise',
                    evidence: 'NICE NG131'
                });
                
                management.prognosis = {
                    summary: 'Presumed localised disease - uncertain without histology',
                    median: 'Variable - many patients die WITH prostate cancer not FROM it',
                    fiveYear: 'Generally good if truly localised'
                };
            }
            
            // SUPPORTIVE CARE for all
            if (data.bonePain) {
                management.supportiveCare.push({
                    name: 'Bone Pain Management',
                    detail: 'Analgesia ladder, consider palliative radiotherapy for focal bone pain',
                    evidence: 'NICE NG131'
                });
            }
            
            if (data.anaemia) {
                management.supportiveCare.push({
                    name: 'Anaemia Management',
                    detail: 'Investigate cause (marrow infiltration vs chronic disease), consider transfusion if symptomatic',
                    evidence: 'Standard care'
                });
            }
            
            // MONITORING
            management.monitoring.push({
                name: 'PSA Monitoring',
                detail: 'Check PSA at 3-6 months to assess response to treatment, then every 3-6 months',
                evidence: 'NICE NG131'
            });
            
            if (extent.isMetastatic) {
                management.monitoring.push({
                    name: 'Symptom Review',
                    detail: 'Regular assessment for bone pain, neurological symptoms, urinary symptoms',
                    evidence: 'Standard care'
                });
                management.monitoring.push({
                    name: 'Imaging as Indicated',
                    detail: 'Repeat imaging if symptoms change or PSA rises despite treatment (suggests castration resistance)',
                    evidence: 'EAU 2024'
                });
            }
            
            // NOT RECOMMENDED
            if (data.performance >= 3 || data.lifeExpectancy === 'less1') {
                management.notRecommended.push('Aggressive combination chemotherapy');
                management.notRecommended.push('Complex radical treatments');
            }
            
            if (!extent.isMetastatic && data.lifeExpectancy === 'less1') {
                management.notRecommended.push('Immediate ADT in asymptomatic patient with very limited life expectancy');
            }
            
            return management;
        }
        
        function displayClinicalDiagnosisResults(data, extent, management) {
            let html = '';
            
            // Patient Summary
            html += `
                <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-blue);">
                    <div class="info-box-title">üìã Clinical Presentation Summary</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">
                        ${data.age ? `<div><strong>Age:</strong> ${data.age} years</div>` : ''}
                        ${data.psa ? `<div><strong>PSA:</strong> ${data.psa} ng/ml</div>` : ''}
                        ${data.performance ? `<div><strong>Performance Status:</strong> PS ${data.performance}</div>` : ''}
                        ${data.dre ? `<div><strong>DRE:</strong> ${formatDRE(data.dre)}</div>` : ''}
                        ${data.clinicalT ? `<div><strong>Clinical T Stage:</strong> ${data.clinicalT}</div>` : ''}
                        ${data.lifeExpectancy ? `<div><strong>Life Expectancy:</strong> ${formatLifeExpectancy(data.lifeExpectancy)}</div>` : ''}
                    </div>
                </div>
            `;
            
            // Disease Extent Alert
            let extentAlertClass = extent.isMetastatic ? 'urgent' : (extent.isLocallyAdvanced ? 'warning' : 'info');
            let extentIcon = extent.isMetastatic ? 'üö®' : (extent.isLocallyAdvanced ? '‚ö†Ô∏è' : 'üìã');
            
            html += `
                <div class="alert alert-${extentAlertClass}">
                    <span class="alert-icon">${extentIcon}</span>
                    <div>
                        <div class="alert-title">Clinical Stage: ${extent.category}</div>
                        <div class="alert-text">
                            <strong>Stage:</strong> ${extent.clinicalStage}
                            ${extent.isMetastatic ? `<br><strong>Metastatic Sites:</strong> ${extent.metastaticSites.join(', ') || 'To be determined'}` : ''}
                            ${extent.isMetastatic ? `<br><strong>Disease Volume:</strong> ${extent.isHighVolume ? 'HIGH volume' : 'LOW volume'}` : ''}
                            ${extent.hasVisceralMets ? '<br><span style="color: var(--accent-red);">‚ö†Ô∏è Visceral metastases present - adverse prognostic feature</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // URGENT ACTIONS
            if (management.urgentActions.length > 0) {
                html += `
                    <div class="alert alert-urgent" style="margin-bottom: 24px;">
                        <span class="alert-icon">üö®</span>
                        <div>
                            <div class="alert-title">URGENT ACTIONS REQUIRED</div>
                            <div class="alert-text">
                                <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                    ${management.urgentActions.map(a => `<li><strong>${a.action}:</strong> ${a.detail}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Reason for Clinical Diagnosis
            const reasons = [];
            if (data.reasonFrailty) reasons.push('Patient frailty');
            if (data.reasonMetastatic) reasons.push('Clear metastatic disease');
            if (data.reasonPsa) reasons.push('Very high PSA with typical features');
            if (data.reasonLifeExpectancy) reasons.push('Limited life expectancy');
            if (data.reasonPatientChoice) reasons.push('Patient choice');
            if (data.reasonAnticoag) reasons.push('Anticoagulation/bleeding risk');
            
            if (reasons.length > 0) {
                html += `
                    <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-amber);">
                        <div class="info-box-title">üìù Clinical Diagnosis Rationale</div>
                        <p style="color: var(--text-secondary); margin-top: 8px;">Biopsy not performed due to: <strong>${reasons.join(', ')}</strong></p>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">
                            <em>Per NICE NG131: "In men with clinical features of advanced prostate cancer and very high PSA levels, 
                            a clinical diagnosis of prostate cancer may be appropriate without histological confirmation."</em>
                        </p>
                    </div>
                `;
            }
            
            // Primary Treatment
            html += `
                <div class="management-section" style="margin-bottom: 24px;">
                    <div class="management-title">üéØ Recommended Treatment (NICE NG131 / EAU 2024)</div>
                    <div class="investigation-list">
            `;
            
            management.primaryTreatment.forEach((t, i) => {
                html += `
                    <div class="investigation-item recommended" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                            <div class="investigation-icon">üíä</div>
                            <div class="investigation-details">
                                <div class="investigation-name">${t.name}</div>
                                <div class="investigation-desc">${t.detail}</div>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted); padding-left: 52px;">
                            <em>Evidence: ${t.evidence}</em>
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            
            // Supportive Care
            if (management.supportiveCare.length > 0) {
                html += `
                    <div class="management-section" style="margin-bottom: 24px;">
                        <div class="management-title">üè• Supportive Care</div>
                        <div class="investigation-list">
                `;
                management.supportiveCare.forEach(s => {
                    html += `
                        <div class="investigation-item optional">
                            <div class="investigation-icon">‚ù§Ô∏è</div>
                            <div class="investigation-details">
                                <div class="investigation-name">${s.name}</div>
                                <div class="investigation-desc">${s.detail}</div>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            // Monitoring
            html += `
                <div class="management-section" style="margin-bottom: 24px;">
                    <div class="management-title">üìä Monitoring Plan</div>
                    <div class="investigation-list">
            `;
            management.monitoring.forEach(m => {
                html += `
                    <div class="investigation-item" style="border-left-color: var(--accent-cyan);">
                        <div class="investigation-icon">üìà</div>
                        <div class="investigation-details">
                            <div class="investigation-name">${m.name}</div>
                            <div class="investigation-desc">${m.detail}</div>
                        </div>
                    </div>
                `;
            });
            html += `</div></div>`;
            
            // Considerations
            if (management.considerations.length > 0) {
                html += `
                    <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-cyan);">
                        <div class="info-box-title">üí° Additional Considerations</div>
                        <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary);">
                            ${management.considerations.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Not Recommended
            if (management.notRecommended.length > 0) {
                html += `
                    <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-red);">
                        <div class="info-box-title" style="color: var(--accent-red);">‚õî Not Recommended</div>
                        <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary);">
                            ${management.notRecommended.map(n => `<li>${n}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Prognosis
            html += `
                <div class="management-section" style="margin-bottom: 24px;">
                    <div class="management-title">üìà Prognosis Estimate</div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 10px;">
                        <p><strong>${management.prognosis.summary}</strong></p>
                        <table style="width: 100%; margin-top: 12px; font-size: 0.9rem;">
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 10px 0;">Median Survival</td>
                                <td style="padding: 10px 0; text-align: right; color: var(--accent-cyan);">${management.prognosis.median}</td>
                            </tr>
                            ${management.prognosis.fiveYear ? `
                            <tr>
                                <td style="padding: 10px 0;">5-Year Survival</td>
                                <td style="padding: 10px 0; text-align: right; color: var(--accent-cyan);">${management.prognosis.fiveYear}</td>
                            </tr>
                            ` : ''}
                        </table>
                        <p style="margin-top: 12px; font-size: 0.85rem; color: var(--text-muted);">
                            <em>Note: Prognosis estimates are population-based and may not reflect individual outcomes. 
                            Clinical diagnosis without histology adds uncertainty to staging.</em>
                        </p>
                    </div>
                </div>
            `;
            
            // MDT Discussion
            html += `
                <div class="alert alert-info" style="margin-bottom: 24px;">
                    <span class="alert-icon">üë•</span>
                    <div>
                        <div class="alert-title">MDT Discussion Required</div>
                        <div class="alert-text">
                            All cases should be discussed at MDT even without histological diagnosis. Document:
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                <li>Rationale for clinical diagnosis without biopsy</li>
                                <li>Patient fitness, frailty assessment, and life expectancy</li>
                                <li>Patient preferences and goals of care</li>
                                <li>Agreed management plan</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            // Palliative Care
            if (extent.isMetastatic || data.lifeExpectancy === 'less1' || data.lifeExpectancy === '1-2' || data.performance >= 3) {
                html += `
                    <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-purple);">
                        <div class="info-box-title" style="color: var(--accent-purple);">ü§ù Palliative Care & Support</div>
                        <p style="color: var(--text-secondary); margin-top: 8px;">
                            Consider early palliative care referral for symptom management and advance care planning.
                            Ensure patient has access to:
                        </p>
                        <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary);">
                            <li>Clinical Nurse Specialist support</li>
                            <li>Palliative care team if symptomatic</li>
                            <li>Psychological support services</li>
                            <li>Prostate Cancer UK resources</li>
                        </ul>
                    </div>
                `;
            }
            
            // Guidelines Reference
            html += `
                <div class="info-box" style="background: var(--bg-card);">
                    <div class="info-box-title">üìñ Guidelines References</div>
                    <ul style="margin-top: 12px; padding-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                        <li>NICE NG131: Prostate cancer: diagnosis and management (Section 1.3 - Managing localised and locally advanced prostate cancer)</li>
                        <li>NICE NG131: Section 1.4 - Managing metastatic prostate cancer</li>
                        <li>EAU Guidelines 2024: Metastatic hormone-sensitive prostate cancer</li>
                        <li>NICE CG75: Metastatic spinal cord compression (if applicable)</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('clinical-diagnosis-output').innerHTML = html;
            document.getElementById('step8-results').classList.add('visible');
            
            // Scroll to results
            setTimeout(() => {
                document.getElementById('step8-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }
        
        function formatDRE(dre) {
            const map = {
                'normal': 'Normal',
                'enlarged-smooth': 'Enlarged, smooth',
                'nodule': 'Nodule/Induration',
                'hard-irregular': 'Hard, irregular',
                'fixed': 'Fixed',
                'not-done': 'Not performed'
            };
            return map[dre] || dre;
        }
        
        function formatLifeExpectancy(le) {
            const map = {
                'less1': '< 1 year',
                '1-2': '1-2 years',
                '2-5': '2-5 years',
                '5-10': '5-10 years',
                'more10': '> 10 years'
            };
            return map[le] || le;
        }
        
        function calculateComprehensiveRisk() {
            // Gather all data from Step 4
            const data = {
                age: parseInt(document.getElementById('s4-age').value),
                performance: document.getElementById('s4-performance').value,
                lifeExpectancy: document.getElementById('s4-life-expectancy').value,
                comorbidities: document.getElementById('s4-comorbidities').value,
                psa: parseFloat(document.getElementById('s4-psa').value),
                psaVelocity: parseFloat(document.getElementById('s4-psa-velocity').value),
                psaDoubling: parseFloat(document.getElementById('s4-psa-doubling').value),
                gleason: parseInt(document.getElementById('s4-gleason').value),
                coresPositive: document.getElementById('s4-cores-positive').value,
                maxCore: parseInt(document.getElementById('s4-max-core').value),
                dre: document.getElementById('s4-dre').value,
                pirads: parseInt(document.getElementById('s4-pirads').value),
                prostateVolume: parseFloat(document.getElementById('s4-prostate-volume').value),
                lesionSize: parseFloat(document.getElementById('s4-lesion-size').value),
                epe: document.getElementById('s4-epe').value,
                svi: document.getElementById('s4-svi').value,
                lymphMri: document.getElementById('s4-lymph-mri').value,
                tStage: document.getElementById('s4-t-stage').value,
                nStage: document.getElementById('s4-n-stage').value,
                mStage: document.getElementById('s4-m-stage').value,
                boneScan: document.getElementById('s4-bone-scan').value,
                ctCap: document.getElementById('s4-ct-cap').value,
                psmaPet: document.getElementById('s4-psma-pet').value,
                perineural: document.getElementById('s4-perineural').checked,
                lymphovascular: document.getElementById('s4-lymphovascular').checked,
                cribriform: document.getElementById('s4-cribriform').checked,
                intraductal: document.getElementById('s4-intraductal').checked,
                brca: document.getElementById('s4-brca').checked
            };
            
            // Validation - minimum required fields
            if (!data.psa || !data.gleason || !data.tStage) {
                alert('Please enter at least PSA, Grade Group, and T Stage to calculate risk');
                return;
            }
            
            // Calculate disease stage
            const stageResult = calculateDiseaseStage(data);
            
            // Calculate EAU risk group
            const riskGroup = calculateEAURiskGroup(data);
            
            // Calculate prognosis estimates
            const prognosis = calculatePrognosis(data, stageResult, riskGroup);
            
            // Generate treatment recommendations
            const treatment = generateTreatmentRecommendations(data, stageResult, riskGroup);
            
            // Display results
            displayComprehensiveResults(data, stageResult, riskGroup, prognosis, treatment);
        }
        
        function calculateDiseaseStage(data) {
            // Determine overall stage based on TNM
            let stage = '';
            let stageGroup = '';
            let isMetastatic = false;
            let metastaticType = '';
            let metastaticVolume = '';
            
            // Check for metastatic disease
            if (data.mStage && data.mStage !== 'M0' && data.mStage !== 'Mx') {
                isMetastatic = true;
                if (data.mStage === 'M1a') {
                    metastaticType = 'Non-regional lymph node metastases';
                } else if (data.mStage === 'M1b') {
                    metastaticType = 'Bone metastases';
                } else if (data.mStage === 'M1c') {
                    metastaticType = 'Visceral metastases (¬± bone)';
                }
                stage = 'IV';
                stageGroup = 'Stage IV (Metastatic)';
            }
            
            // Determine metastatic volume (CHAARTED/LATITUDE criteria)
            if (data.boneScan === 'positive-high' || data.psmaPet === 'bone-poly' || data.psmaPet === 'widespread') {
                metastaticVolume = 'high';
            } else if (data.boneScan === 'positive-oligo' || data.psmaPet === 'bone-oligo') {
                metastaticVolume = 'low';
            } else if (data.ctCap === 'visceral' || data.ctCap === 'both' || data.psmaPet === 'visceral') {
                metastaticVolume = 'high'; // Visceral mets = high volume
            }
            
            // Check for locally advanced
            if (!isMetastatic) {
                if (data.tStage === 'T3a' || data.tStage === 'T3b' || data.tStage === 'T4') {
                    stage = 'III';
                    stageGroup = 'Stage III (Locally Advanced)';
                } else if (data.nStage === 'N1') {
                    stage = 'III';
                    stageGroup = 'Stage III (Node Positive)';
                } else {
                    // Localised disease
                    if (data.tStage.startsWith('T1')) {
                        stage = 'I';
                        stageGroup = 'Stage I (Localised)';
                    } else if (data.tStage.startsWith('T2')) {
                        stage = 'II';
                        stageGroup = 'Stage II (Localised)';
                    }
                }
            }
            
            return {
                stage,
                stageGroup,
                isMetastatic,
                metastaticType,
                metastaticVolume,
                isLocallyAdvanced: stage === 'III' && !isMetastatic,
                isNodePositive: data.nStage === 'N1',
                hasVisceralMets: data.ctCap === 'visceral' || data.ctCap === 'both' || data.psmaPet === 'visceral'
            };
        }
        
        function calculateEAURiskGroup(data) {
            // EAU 2024 Risk Classification for localised/locally advanced disease
            // Also considers NICE NG131 criteria
            
            let riskGroup = '';
            let riskFactors = [];
            
            const psa = data.psa;
            const gg = data.gleason;
            const tStage = data.tStage;
            
            // Low Risk: PSA <10 AND GG1 AND cT1-2a
            // Intermediate Risk: PSA 10-20 OR GG2-3 OR cT2b
            // High Risk: PSA >20 OR GG4-5 OR cT2c OR cT3-4 OR cN+
            
            // Count risk factors
            if (psa >= 20) riskFactors.push('PSA ‚â•20 ng/ml');
            else if (psa >= 10) riskFactors.push('PSA 10-20 ng/ml');
            
            if (gg >= 4) riskFactors.push('Grade Group 4-5');
            else if (gg >= 2) riskFactors.push('Grade Group 2-3');
            
            if (tStage === 'T3a' || tStage === 'T3b' || tStage === 'T4') {
                riskFactors.push('T3-4 disease');
            } else if (tStage === 'T2c') {
                riskFactors.push('T2c (both lobes)');
            } else if (tStage === 'T2b') {
                riskFactors.push('T2b (>half lobe)');
            }
            
            if (data.nStage === 'N1') riskFactors.push('Node positive (N1)');
            
            // Additional adverse features
            if (data.cribriform) riskFactors.push('Cribriform pattern');
            if (data.intraductal) riskFactors.push('Intraductal carcinoma');
            if (data.brca) riskFactors.push('BRCA mutation');
            if (data.psaVelocity > 2) riskFactors.push('PSA velocity >2 ng/ml/year');
            
            // Determine risk group
            if (data.nStage === 'N1' || tStage === 'T3b' || tStage === 'T4') {
                riskGroup = 'Very High Risk';
            } else if (psa > 20 || gg >= 4 || tStage === 'T3a' || tStage === 'T2c') {
                riskGroup = 'High Risk';
            } else if ((psa >= 10 && psa <= 20) || gg === 2 || gg === 3 || tStage === 'T2b') {
                // Subdivide intermediate risk (EAU 2024)
                if (gg === 3 || (gg === 2 && data.maxCore > 50) || (data.coresPositive && parseCores(data.coresPositive) > 0.5)) {
                    riskGroup = 'Intermediate Risk - Unfavourable';
                } else {
                    riskGroup = 'Intermediate Risk - Favourable';
                }
            } else if (psa < 10 && gg === 1 && (tStage === 'T1a' || tStage === 'T1b' || tStage === 'T1c' || tStage === 'T2a')) {
                riskGroup = 'Low Risk';
            } else {
                riskGroup = 'Intermediate Risk - Favourable';
            }
            
            return {
                group: riskGroup,
                factors: riskFactors,
                isLow: riskGroup === 'Low Risk',
                isIntermediate: riskGroup.includes('Intermediate'),
                isFavourable: riskGroup.includes('Favourable'),
                isUnfavourable: riskGroup.includes('Unfavourable'),
                isHigh: riskGroup === 'High Risk',
                isVeryHigh: riskGroup === 'Very High Risk'
            };
        }
        
        function parseCores(coresString) {
            if (!coresString) return 0;
            const parts = coresString.split('/');
            if (parts.length === 2) {
                return parseInt(parts[0]) / parseInt(parts[1]);
            }
            return 0;
        }
        
        function calculatePrognosis(data, stage, risk) {
            // Prognosis estimates based on EAU/NICE guidelines and published data
            // These are approximate population-based estimates
            
            let prognosis = {
                fiveYearSurvival: '',
                tenYearSurvival: '',
                cancerSpecificSurvival: '',
                biochemicalRecurrence: '',
                metastasisFreeInterval: '',
                prognosticFactors: [],
                adverseFactors: []
            };
            
            if (stage.isMetastatic) {
                if (stage.metastaticVolume === 'high' || stage.hasVisceralMets) {
                    prognosis.fiveYearSurvival = '30-40%';
                    prognosis.cancerSpecificSurvival = 'Median 3-4 years with optimal treatment';
                    prognosis.adverseFactors.push('High volume metastatic disease');
                } else {
                    prognosis.fiveYearSurvival = '50-60%';
                    prognosis.cancerSpecificSurvival = 'Median 4-6 years with optimal treatment';
                    prognosis.prognosticFactors.push('Low volume metastatic disease - better prognosis');
                }
                
                if (data.gleason >= 4) {
                    prognosis.adverseFactors.push('High grade disease (GG4-5)');
                }
                if (stage.hasVisceralMets) {
                    prognosis.adverseFactors.push('Visceral metastases present');
                }
                
            } else if (stage.isLocallyAdvanced || stage.isNodePositive) {
                prognosis.fiveYearSurvival = '85-95%';
                prognosis.tenYearSurvival = '70-85%';
                prognosis.cancerSpecificSurvival = '80-90% at 10 years with multimodal treatment';
                prognosis.biochemicalRecurrence = '30-50% at 10 years';
                
                if (stage.isNodePositive) {
                    prognosis.adverseFactors.push('Lymph node involvement');
                }
                if (data.tStage === 'T3b') {
                    prognosis.adverseFactors.push('Seminal vesicle invasion');
                }
                
            } else {
                // Localised disease
                if (risk.isLow) {
                    prognosis.fiveYearSurvival = '>99%';
                    prognosis.tenYearSurvival = '95-99%';
                    prognosis.cancerSpecificSurvival = '99% at 15 years';
                    prognosis.biochemicalRecurrence = '<5% at 5 years (if treated)';
                    prognosis.metastasisFreeInterval = '99% at 10 years';
                    prognosis.prognosticFactors.push('Excellent prognosis - most men die WITH not FROM prostate cancer');
                } else if (risk.isFavourable) {
                    prognosis.fiveYearSurvival = '>98%';
                    prognosis.tenYearSurvival = '90-95%';
                    prognosis.cancerSpecificSurvival = '95% at 10 years';
                    prognosis.biochemicalRecurrence = '10-20% at 5 years';
                    prognosis.metastasisFreeInterval = '95% at 10 years';
                } else if (risk.isUnfavourable) {
                    prognosis.fiveYearSurvival = '95-98%';
                    prognosis.tenYearSurvival = '85-92%';
                    prognosis.cancerSpecificSurvival = '90% at 10 years';
                    prognosis.biochemicalRecurrence = '20-35% at 5 years';
                    prognosis.metastasisFreeInterval = '85-90% at 10 years';
                } else if (risk.isHigh) {
                    prognosis.fiveYearSurvival = '90-95%';
                    prognosis.tenYearSurvival = '75-85%';
                    prognosis.cancerSpecificSurvival = '80-85% at 10 years';
                    prognosis.biochemicalRecurrence = '40-60% at 5 years';
                    prognosis.metastasisFreeInterval = '70-80% at 10 years';
                } else if (risk.isVeryHigh) {
                    prognosis.fiveYearSurvival = '85-92%';
                    prognosis.tenYearSurvival = '65-80%';
                    prognosis.cancerSpecificSurvival = '70-80% at 10 years';
                    prognosis.biochemicalRecurrence = '50-70% at 5 years';
                    prognosis.metastasisFreeInterval = '60-75% at 10 years';
                }
            }
            
            // Add specific prognostic modifiers
            if (data.cribriform || data.intraductal) {
                prognosis.adverseFactors.push('Cribriform/intraductal pattern - associated with worse outcomes');
            }
            if (data.brca) {
                prognosis.adverseFactors.push('BRCA mutation - associated with more aggressive disease');
            }
            if (data.psaDoubling && data.psaDoubling < 10) {
                prognosis.adverseFactors.push('Short PSA doubling time (<10 months)');
            }
            if (data.perineural) {
                prognosis.adverseFactors.push('Perineural invasion present');
            }
            if (data.lymphovascular) {
                prognosis.adverseFactors.push('Lymphovascular invasion present');
            }
            
            // Age consideration
            if (data.age > 75) {
                prognosis.prognosticFactors.push('Age >75 - competing mortality risks important');
            }
            if (data.lifeExpectancy === 'less5') {
                prognosis.prognosticFactors.push('Limited life expectancy - treatment may not benefit survival');
            }
            
            return prognosis;
        }
        
        function generateTreatmentRecommendations(data, stage, risk) {
            let treatment = {
                primary: [],
                alternatives: [],
                adjuvant: [],
                contraindicated: [],
                considerations: [],
                urgency: '',
                mdtRequired: true
            };
            
            if (stage.isMetastatic) {
                treatment.urgency = 'URGENT - initiate within 2-4 weeks';
                
                // Metastatic hormone-sensitive prostate cancer (mHSPC)
                treatment.primary.push({
                    name: 'ADT + Novel Hormonal Agent (Triplet/Doublet)',
                    details: 'ADT (LHRH agonist/antagonist or bilateral orchidectomy) PLUS one of: Abiraterone + Prednisolone, Enzalutamide, Apalutamide, or Darolutamide',
                    evidence: 'NICE NG131, EAU 2024 - Standard of care for mHSPC'
                });
                
                if (stage.metastaticVolume === 'high') {
                    treatment.primary.push({
                        name: 'Consider Triplet Therapy',
                        details: 'ADT + Docetaxel + Abiraterone/Darolutamide for fit patients with high-volume disease',
                        evidence: 'PEACE-1, ARASENS trials'
                    });
                }
                
                if (stage.metastaticVolume === 'low') {
                    treatment.considerations.push('Low-volume metastatic disease - consider local treatment to primary (RT) in addition to systemic therapy (STAMPEDE)');
                }
                
                if (stage.hasVisceralMets) {
                    treatment.considerations.push('Visceral metastases present - poor prognostic feature, consider early intensification');
                }
                
                treatment.alternatives.push({
                    name: 'ADT Monotherapy',
                    details: 'Only if patient unfit for combination therapy or patient preference after discussion',
                    evidence: 'Inferior to combination - discuss with patient'
                });
                
            } else if (stage.isLocallyAdvanced || stage.isNodePositive) {
                treatment.urgency = 'Treatment within 4-6 weeks';
                
                if (stage.isNodePositive) {
                    treatment.primary.push({
                        name: 'Radiotherapy + Long-term ADT',
                        details: 'EBRT to prostate + pelvic nodes with 2-3 years ADT',
                        evidence: 'NICE NG131, EAU 2024 - Standard for N+ disease'
                    });
                    treatment.alternatives.push({
                        name: 'Radical Prostatectomy + ePLND',
                        details: 'In highly selected patients as part of multimodal approach',
                        evidence: 'Consider if limited nodal disease, fit patient'
                    });
                } else {
                    // T3-4 N0
                    treatment.primary.push({
                        name: 'Radiotherapy + Long-term ADT (2-3 years)',
                        details: 'EBRT with dose escalation (74-78 Gy) plus neoadjuvant/concurrent/adjuvant ADT',
                        evidence: 'NICE NG131 - Standard of care for locally advanced'
                    });
                    treatment.primary.push({
                        name: 'Radical Prostatectomy + ePLND',
                        details: 'For selected patients - often requires adjuvant/salvage RT',
                        evidence: 'EAU 2024 - Option in multimodal approach'
                    });
                }
                
            } else {
                // Localised disease
                if (risk.isLow) {
                    treatment.urgency = 'No urgent treatment required';
                    treatment.primary.push({
                        name: 'Active Surveillance',
                        details: 'PSA every 3-6 months, MRI at 12 months, re-biopsy if progression. Standard of care.',
                        evidence: 'NICE NG131, EAU 2024 - RECOMMENDED over immediate treatment'
                    });
                    treatment.alternatives.push({
                        name: 'Radical Prostatectomy',
                        details: 'If patient strongly prefers treatment after counselling',
                        evidence: 'Discuss overtreatment risks'
                    });
                    treatment.alternatives.push({
                        name: 'Radiotherapy (EBRT or Brachytherapy)',
                        details: 'If patient declines surveillance and surgery',
                        evidence: 'Low-dose rate brachytherapy suitable for low-risk'
                    });
                    treatment.contraindicated.push('Long-term ADT - no benefit in low-risk localised disease');
                    
                } else if (risk.isFavourable) {
                    treatment.urgency = 'Treatment decision within 4-6 weeks';
                    treatment.primary.push({
                        name: 'Active Surveillance',
                        details: 'Suitable for selected patients - small volume, older patients',
                        evidence: 'NICE NG131 - Offer to suitable patients'
                    });
                    treatment.primary.push({
                        name: 'Radical Prostatectomy (¬± nerve-sparing)',
                        details: 'Excellent oncological outcomes, consider erectile function',
                        evidence: 'Standard curative option'
                    });
                    treatment.primary.push({
                        name: 'Radiotherapy',
                        details: 'EBRT (dose-escalated) or HDR brachytherapy boost. Consider short-term ADT (6 months)',
                        evidence: 'NICE NG131, EAU 2024'
                    });
                    
                } else if (risk.isUnfavourable) {
                    treatment.urgency = 'Treatment within 4-6 weeks';
                    treatment.primary.push({
                        name: 'Radical Prostatectomy + ePLND',
                        details: 'Extended pelvic lymph node dissection recommended',
                        evidence: 'EAU 2024 - Standard for unfavourable intermediate'
                    });
                    treatment.primary.push({
                        name: 'Radiotherapy + Short-term ADT (6 months)',
                        details: 'EBRT with dose escalation to 76-78 Gy',
                        evidence: 'NICE NG131'
                    });
                    treatment.contraindicated.push('Active surveillance generally not recommended');
                    
                } else if (risk.isHigh || risk.isVeryHigh) {
                    treatment.urgency = risk.isVeryHigh ? 'TREAT WITHIN 1 MONTH' : 'Treatment within 4 weeks';
                    treatment.primary.push({
                        name: 'Radiotherapy + Long-term ADT (2-3 years)',
                        details: 'EBRT 74-78 Gy + neoadjuvant/concurrent/adjuvant ADT. Consider pelvic nodal RT.',
                        evidence: 'NICE NG131, EAU 2024 - Standard of care'
                    });
                    treatment.primary.push({
                        name: 'Radical Prostatectomy + ePLND',
                        details: 'For fit patients willing to accept likely need for adjuvant treatment',
                        evidence: 'Part of multimodal approach'
                    });
                    
                    if (risk.isVeryHigh) {
                        treatment.considerations.push('Very high risk - consider staging with PSMA PET-CT before radical treatment');
                        treatment.considerations.push('High chance of requiring multimodal therapy');
                    }
                    
                    treatment.contraindicated.push('Active surveillance');
                    treatment.contraindicated.push('Monotherapy without ADT (for high risk)');
                }
            }
            
            // Add considerations based on patient factors
            if (data.performance >= 2) {
                treatment.considerations.push('Reduced performance status - may not tolerate aggressive treatment');
            }
            if (data.lifeExpectancy === 'less5') {
                treatment.considerations.push('Life expectancy <5 years - watchful waiting may be appropriate, palliative approach');
            }
            if (data.age > 75 && !stage.isMetastatic) {
                treatment.considerations.push('Age >75 - carefully weigh treatment benefits against competing mortality');
            }
            if (data.brca) {
                treatment.considerations.push('BRCA mutation - may benefit from PARP inhibitors if castration-resistant');
            }
            
            return treatment;
        }
        
        function displayComprehensiveResults(data, stage, risk, prognosis, treatment) {
            let html = '';
            
            // Patient Summary Box
            html += `
                <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-blue);">
                    <div class="info-box-title">üìã Patient Summary</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">
                        ${data.age ? `<div><strong>Age:</strong> ${data.age} years</div>` : ''}
                        ${data.psa ? `<div><strong>PSA:</strong> ${data.psa} ng/ml</div>` : ''}
                        ${data.gleason ? `<div><strong>Grade Group:</strong> ${data.gleason}</div>` : ''}
                        ${data.tStage ? `<div><strong>T Stage:</strong> ${data.tStage}</div>` : ''}
                        ${data.nStage ? `<div><strong>N Stage:</strong> ${data.nStage}</div>` : ''}
                        ${data.mStage ? `<div><strong>M Stage:</strong> ${data.mStage}</div>` : ''}
                    </div>
                </div>
            `;
            
            // Disease Stage Alert
            let stageAlertClass = 'info';
            let stageIcon = 'üìä';
            if (stage.isMetastatic) {
                stageAlertClass = 'urgent';
                stageIcon = 'üö®';
            } else if (stage.isLocallyAdvanced || stage.isNodePositive) {
                stageAlertClass = 'warning';
                stageIcon = '‚ö†Ô∏è';
            } else if (risk.isLow) {
                stageAlertClass = 'success';
                stageIcon = '‚úì';
            }
            
            html += `
                <div class="alert alert-${stageAlertClass}">
                    <span class="alert-icon">${stageIcon}</span>
                    <div>
                        <div class="alert-title">${stage.stageGroup}</div>
                        <div class="alert-text">
                            <strong>EAU Risk Classification:</strong> ${risk.group}
                            ${stage.isMetastatic && stage.metastaticVolume ? `<br><strong>Metastatic Volume:</strong> ${stage.metastaticVolume.toUpperCase()} volume disease` : ''}
                            ${stage.metastaticType ? `<br><strong>Metastatic Sites:</strong> ${stage.metastaticType}` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Risk Factors
            if (risk.factors.length > 0) {
                html += `
                    <div class="info-box" style="margin-bottom: 24px;">
                        <div class="info-box-title">Risk Factors Present</div>
                        <div class="tag-container">
                            ${risk.factors.map(f => `<span class="tag" style="background: rgba(245, 158, 11, 0.2); border-color: rgba(245, 158, 11, 0.3);">${f}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Treatment Urgency
            if (treatment.urgency) {
                const urgencyClass = treatment.urgency.includes('URGENT') || treatment.urgency.includes('MONTH') ? 'urgent' : 'warning';
                html += `
                    <div class="alert alert-${urgencyClass}" style="margin-bottom: 24px;">
                        <span class="alert-icon">‚è±Ô∏è</span>
                        <div>
                            <div class="alert-title">Treatment Timeline</div>
                            <div class="alert-text">${treatment.urgency}</div>
                        </div>
                    </div>
                `;
            }
            
            // Primary Treatment Recommendations
            html += `
                <div class="management-section" style="margin-bottom: 24px;">
                    <div class="management-title">üéØ Primary Treatment Options (NICE NG131 / EAU 2024)</div>
                    <div class="investigation-list">
            `;
            
            treatment.primary.forEach((t, i) => {
                html += `
                    <div class="investigation-item recommended" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                            <div class="investigation-icon">üíä</div>
                            <div class="investigation-details">
                                <div class="investigation-name">${t.name}</div>
                                <div class="investigation-desc">${t.details}</div>
                            </div>
                            <span class="investigation-priority priority-recommended">${i === 0 ? 'Preferred' : 'Option'}</span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted); padding-left: 52px;">
                            <em>Evidence: ${t.evidence}</em>
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            
            // Alternative Options
            if (treatment.alternatives.length > 0) {
                html += `
                    <div class="management-section" style="margin-bottom: 24px;">
                        <div class="management-title">Alternative Options</div>
                        <div class="investigation-list">
                `;
                treatment.alternatives.forEach(t => {
                    html += `
                        <div class="investigation-item optional">
                            <div class="investigation-icon">üìã</div>
                            <div class="investigation-details">
                                <div class="investigation-name">${t.name}</div>
                                <div class="investigation-desc">${t.details}</div>
                            </div>
                            <span class="investigation-priority priority-optional">Alternative</span>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            // Contraindicated
            if (treatment.contraindicated.length > 0) {
                html += `
                    <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-red);">
                        <div class="info-box-title" style="color: var(--accent-red);">‚õî Not Recommended</div>
                        <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary);">
                            ${treatment.contraindicated.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Clinical Considerations
            if (treatment.considerations.length > 0) {
                html += `
                    <div class="info-box" style="margin-bottom: 24px; border-left: 4px solid var(--accent-amber);">
                        <div class="info-box-title">‚ö†Ô∏è Clinical Considerations</div>
                        <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary);">
                            ${treatment.considerations.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Prognosis Section
            html += `
                <div class="management-section" style="margin-bottom: 24px;">
                    <div class="management-title">üìà Prognosis Estimates</div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 10px;">
                        <table style="width: 100%; font-size: 0.9rem;">
                            ${prognosis.fiveYearSurvival ? `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 10px 0; font-weight: 500;">5-Year Overall Survival</td>
                                    <td style="padding: 10px 0; text-align: right; color: var(--accent-cyan);">${prognosis.fiveYearSurvival}</td>
                                </tr>
                            ` : ''}
                            ${prognosis.tenYearSurvival ? `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 10px 0; font-weight: 500;">10-Year Overall Survival</td>
                                    <td style="padding: 10px 0; text-align: right; color: var(--accent-cyan);">${prognosis.tenYearSurvival}</td>
                                </tr>
                            ` : ''}
                            ${prognosis.cancerSpecificSurvival ? `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 10px 0; font-weight: 500;">Cancer-Specific Survival</td>
                                    <td style="padding: 10px 0; text-align: right; color: var(--accent-green);">${prognosis.cancerSpecificSurvival}</td>
                                </tr>
                            ` : ''}
                            ${prognosis.biochemicalRecurrence ? `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 10px 0; font-weight: 500;">Biochemical Recurrence Risk</td>
                                    <td style="padding: 10px 0; text-align: right; color: var(--accent-amber);">${prognosis.biochemicalRecurrence}</td>
                                </tr>
                            ` : ''}
                            ${prognosis.metastasisFreeInterval ? `
                                <tr>
                                    <td style="padding: 10px 0; font-weight: 500;">Metastasis-Free Survival</td>
                                    <td style="padding: 10px 0; text-align: right; color: var(--accent-cyan);">${prognosis.metastasisFreeInterval}</td>
                                </tr>
                            ` : ''}
                        </table>
                    </div>
                </div>
            `;
            
            // Prognostic Factors
            if (prognosis.prognosticFactors.length > 0 || prognosis.adverseFactors.length > 0) {
                html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">`;
                
                if (prognosis.prognosticFactors.length > 0) {
                    html += `
                        <div class="info-box" style="border-left: 4px solid var(--accent-green);">
                            <div class="info-box-title" style="color: var(--accent-green);">‚úì Favourable Factors</div>
                            <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary); font-size: 0.85rem;">
                                ${prognosis.prognosticFactors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (prognosis.adverseFactors.length > 0) {
                    html += `
                        <div class="info-box" style="border-left: 4px solid var(--accent-red);">
                            <div class="info-box-title" style="color: var(--accent-red);">‚ö† Adverse Factors</div>
                            <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary); font-size: 0.85rem;">
                                ${prognosis.adverseFactors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            // MDT Discussion
            html += `
                <div class="alert alert-info" style="margin-bottom: 24px;">
                    <span class="alert-icon">üë•</span>
                    <div>
                        <div class="alert-title">MDT Discussion Required</div>
                        <div class="alert-text">
                            All cases must be discussed at the Urology Cancer MDT. Team includes: Urologist, Oncologist, Radiologist, Pathologist, CNS, and patient representative.
                            <br><br>
                            <strong>Ensure documentation of:</strong> Patient fitness and preferences, comorbidities and life expectancy, full staging results, and treatment options discussed.
                        </div>
                    </div>
                </div>
            `;
            
            // Clinical Resources
            html += `
                <div class="info-box" style="margin-bottom: 24px;">
                    <div class="info-box-title">üìö Clinical Resources & Tools</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 12px;">
                        <a href="https://www.predict.nhs.uk/prostate" target="_blank" style="color: var(--accent-cyan); text-decoration: none;">üìä Predict Prostate (NICE)</a>
                        <a href="https://cambridgeprognosticgroup.com" target="_blank" style="color: var(--accent-cyan); text-decoration: none;">üìà CPG Calculator</a>
                        <a href="https://www.nice.org.uk/guidance/ng131" target="_blank" style="color: var(--accent-cyan); text-decoration: none;">üìã NICE NG131 Guidelines</a>
                        <a href="https://uroweb.org/guidelines/prostate-cancer" target="_blank" style="color: var(--accent-cyan); text-decoration: none;">üìò EAU Guidelines 2024</a>
                        <a href="https://www.cancerresearchuk.org/about-cancer/prostate-cancer" target="_blank" style="color: var(--accent-cyan); text-decoration: none;">‚ÑπÔ∏è Patient Information (CRUK)</a>
                        <a href="https://prostatecanceruk.org/" target="_blank" style="color: var(--accent-cyan); text-decoration: none;">üíô Prostate Cancer UK</a>
                    </div>
                </div>
            `;
            
            // Guidelines References
            html += `
                <div class="info-box" style="background: var(--bg-card);">
                    <div class="info-box-title">üìñ Guidelines References</div>
                    <ul style="margin-top: 12px; padding-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                        <li>NICE NG131: Prostate cancer: diagnosis and management (2019, updated 2021)</li>
                        <li>EAU-EANM-ESTRO-ESUR-ISUP-SIOG Guidelines on Prostate Cancer (2024)</li>
                        <li>AJCC Cancer Staging Manual, 8th Edition (TNM Classification)</li>
                        <li>Cambridge Prognostic Group Classification</li>
                        <li>STAMPEDE, CHAARTED, LATITUDE, PEACE-1, ARASENS trial data</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('comprehensive-results').innerHTML = html;
            document.getElementById('step4-results').classList.add('visible');
            
            // Scroll to results
            setTimeout(() => {
                document.getElementById('step4-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }
        
        // ============================================
        // STEP 5, 6, 7 FUNCTIONS INLINE BELOW
        // These will be included inline for single-file deployment

function showTreatmentDetails() {
    const treatment = document.getElementById('s5-treatment').value;
    const riskGroup = document.getElementById('s5-risk-group').value;
    
    if (!treatment) {
        document.getElementById('treatment-details').innerHTML = '<div class="alert alert-info"><span class="alert-icon">‚ÑπÔ∏è</span><div>Please select a treatment modality to view details.</div></div>';
        return;
    }
    
    const treatmentData = getTreatmentData(treatment);
    let html = '';
    
    // Treatment Header
    html += `
        <div class="alert ${treatmentData.alertClass}">
            <span class="alert-icon">${treatmentData.icon}</span>
            <div>
                <div class="alert-title">${treatmentData.name}</div>
                <div class="alert-text">${treatmentData.description}</div>
            </div>
        </div>
    `;
    
    // Suitability check
    if (riskGroup && treatmentData.suitability && treatmentData.suitability[riskGroup]) {
        const suit = treatmentData.suitability[riskGroup];
        html += `
            <div class="info-box" style="margin-bottom: 20px; border-left: 4px solid ${suit.suitable ? 'var(--accent-green)' : 'var(--accent-amber)'};">
                <div class="info-box-title">${suit.suitable ? '‚úì Suitable Option' : '‚ö†Ô∏è Consider Alternatives'}</div>
                <p style="color: var(--text-secondary);">${suit.note}</p>
            </div>
        `;
    }
    
    // Pros
    html += `
        <div class="management-section">
            <div class="management-title" style="color: var(--accent-green);">‚úì Benefits / Advantages</div>
            <ul class="management-list">
                ${treatmentData.pros.map(p => `<li>${p}</li>`).join('')}
            </ul>
        </div>
    `;
    
    // Cons
    html += `
        <div class="management-section">
            <div class="management-title" style="color: var(--accent-amber);">‚ö† Disadvantages / Limitations</div>
            <ul class="management-list">
                ${treatmentData.cons.map(c => `<li>${c}</li>`).join('')}
            </ul>
        </div>
    `;
    
    // Risks
    html += `
        <div class="management-section">
            <div class="management-title" style="color: var(--accent-red);">‚õî Risks & Side Effects</div>
            <ul class="management-list">
                ${treatmentData.risks.map(r => `<li>${r}</li>`).join('')}
            </ul>
        </div>
    `;
    
    // Follow-up summary
    if (treatmentData.followupSummary) {
        html += `
            <div class="info-box" style="margin-bottom: 20px;">
                <div class="info-box-title">üìÖ Follow-up Summary</div>
                <p style="color: var(--text-secondary);">${treatmentData.followupSummary}</p>
            </div>
        `;
    }
    
    // BAUS Patient Information Leaflets
    html += `
        <div class="info-box" style="margin-bottom: 20px; border-left: 4px solid var(--accent-blue);">
            <div class="info-box-title">üìö Patient Information Resources</div>
            <div style="margin-top: 12px;">
                ${treatmentData.bausLinks.map(link => `
                    <a href="${link.url}" target="_blank" style="display: block; color: var(--accent-cyan); margin-bottom: 8px; text-decoration: none;">
                        üìÑ ${link.title}
                    </a>
                `).join('')}
                ${treatmentData.otherLinks ? treatmentData.otherLinks.map(link => `
                    <a href="${link.url}" target="_blank" style="display: block; color: var(--accent-cyan); margin-bottom: 8px; text-decoration: none;">
                        üîó ${link.title}
                    </a>
                `).join('') : ''}
            </div>
        </div>
    `;
    
    document.getElementById('treatment-details').innerHTML = html;
}

function getTreatmentData(treatment) {
    const treatments = {
        'active-surveillance': {
            name: 'Active Surveillance',
            icon: 'üëÅÔ∏è',
            alertClass: 'alert-success',
            description: 'Close monitoring of low-risk prostate cancer with regular PSA tests, MRI scans, and biopsies. Treatment is deferred unless cancer shows signs of progression.',
            pros: [
                'Avoids or delays side effects of radical treatment (incontinence, erectile dysfunction)',
                'Maintains quality of life during monitoring period',
                'Approximately 50-60% of men on AS never need treatment',
                'Does not compromise cure rates if treatment becomes necessary',
                'NICE NG131 recommended standard of care for low-risk disease'
            ],
            cons: [
                'Requires ongoing monitoring (PSA tests, MRI scans, possible repeat biopsies)',
                'Psychological burden of "living with cancer"',
                'Small risk of missing window for cure if monitoring is inadequate',
                'Approximately 30-50% will eventually need treatment within 10 years'
            ],
            risks: [
                'Disease progression (detected by monitoring)',
                'Anxiety and psychological distress',
                'Biopsy complications if repeat biopsies needed (infection, bleeding)',
                'Risk of developing higher-grade disease (uncommon with proper monitoring)'
            ],
            followupSummary: 'Year 1: PSA every 3 months. Year 2+: PSA every 6 months. MRI at 12 months then as indicated. Re-biopsy only if clinical/radiological progression.',
            suitability: {
                'low': { suitable: true, note: 'Active surveillance is the RECOMMENDED standard of care for low-risk prostate cancer (NICE NG131).' },
                'intermediate-favourable': { suitable: true, note: 'Active surveillance is appropriate for selected patients with favourable intermediate-risk disease.' },
                'intermediate-unfavourable': { suitable: false, note: 'Active surveillance is generally NOT recommended. Consider radical treatment.' },
                'high': { suitable: false, note: 'Active surveillance is NOT appropriate for high-risk disease.' },
                'very-high': { suitable: false, note: 'NOT appropriate. Urgent treatment required.' }
            },
            bausLinks: [
                { title: 'BAUS: Active Surveillance for Prostate Cancer', url: 'https://www.baus.org.uk/patients/conditions/8/active_surveillance_for_prostate_cancer' }
            ],
            otherLinks: [
                { title: 'Prostate Cancer UK: Active Surveillance', url: 'https://prostatecanceruk.org/prostate-information/treatments/active-surveillance' }
            ]
        },
        'watchful-waiting': {
            name: 'Watchful Waiting',
            icon: '‚è≥',
            alertClass: 'alert-info',
            description: 'Less intensive monitoring for men with limited life expectancy. Treatment only given if symptoms develop. No routine PSA monitoring or biopsies.',
            pros: [
                'Avoids all treatment side effects',
                'No regular investigations or hospital visits required',
                'Appropriate for frail patients or those with limited life expectancy (<10 years)',
                'Focus on quality of life rather than cancer control',
                'Most men with low-risk disease will die WITH prostate cancer, not FROM it'
            ],
            cons: [
                'Not curative - cancer may progress',
                'May develop symptoms requiring palliative treatment later',
                'Not suitable for fit men with long life expectancy',
                'Does not provide the reassurance of regular monitoring'
            ],
            risks: [
                'Disease progression to symptomatic/metastatic disease',
                'May require hormonal therapy if symptoms develop',
                'Bone pain, urinary obstruction if disease advances'
            ],
            followupSummary: 'Symptom-based follow-up only. PSA only if clinically indicated. No routine imaging or biopsies. Review if new symptoms develop.',
            suitability: {
                'low': { suitable: true, note: 'Appropriate for men with life expectancy <10 years or significant comorbidities.' },
                'intermediate-favourable': { suitable: true, note: 'May be appropriate for older men with limited life expectancy.' },
                'intermediate-unfavourable': { suitable: false, note: 'Consider more active management unless life expectancy very limited.' },
                'high': { suitable: false, note: 'Generally not appropriate unless very limited life expectancy.' }
            },
            bausLinks: [
                { title: 'BAUS: Watchful Waiting', url: 'https://www.baus.org.uk/patients/conditions/9/watchful_waiting' }
            ],
            otherLinks: [
                { title: 'NICE NG131: Watchful Waiting', url: 'https://www.nice.org.uk/guidance/ng131' }
            ]
        },
        'radical-prostatectomy': {
            name: 'Radical Prostatectomy',
            icon: 'üî™',
            alertClass: 'alert-warning',
            description: 'Surgical removal of the entire prostate gland and seminal vesicles. Usually performed robotically (RARP). May include pelvic lymph node dissection.',
            pros: [
                'Potentially curative - removes entire cancer',
                'Provides accurate pathological staging information',
                'PSA should become undetectable if successful',
                'Clear endpoint for treatment',
                'Salvage radiotherapy available if recurrence occurs',
                'Good long-term cancer control rates (>90% 10-year survival for localised disease)'
            ],
            cons: [
                'Major surgery requiring general anaesthesia',
                'Hospital stay 1-3 days, recovery 4-6 weeks',
                'Higher immediate impact on continence and sexual function than RT',
                'May require adjuvant or salvage treatments',
                'Permanent if complications occur'
            ],
            risks: [
                'Erectile dysfunction: 30-70% (depends on nerve-sparing, baseline function, age)',
                'Urinary incontinence: 5-20% long-term significant incontinence',
                'Bladder neck contracture: 2-5%',
                'Surgical complications: bleeding, infection, DVT/PE (<5%)',
                'Positive surgical margins: 10-30% (may need further treatment)',
                'Lymphocele if lymph node dissection performed'
            ],
            suitability: {
                'low': { suitable: true, note: 'Curative option but active surveillance usually preferred.' },
                'intermediate-favourable': { suitable: true, note: 'Excellent option. Consider nerve-sparing if appropriate.' },
                'intermediate-unfavourable': { suitable: true, note: 'Recommended option. Extended PLND usually indicated.' },
                'high': { suitable: true, note: 'Recommended as part of multimodal treatment.' },
                'very-high': { suitable: true, note: 'Option for selected patients as part of multimodal approach.' }
            },
            bausLinks: [
                { title: 'BAUS: Radical Prostatectomy', url: 'https://www.baus.org.uk/patients/conditions/10/radical_prostatectomy' },
                { title: 'BAUS: Robotic Prostatectomy', url: 'https://www.baus.org.uk/patients/conditions/11/robotic_prostatectomy' }
            ],
            otherLinks: [
                { title: 'Prostate Cancer UK: Surgery', url: 'https://prostatecanceruk.org/prostate-information/treatments/surgery' }
            ]
        },
        'ebrt': {
            name: 'External Beam Radiotherapy (EBRT)',
            icon: '‚ò¢Ô∏è',
            alertClass: 'alert-warning',
            description: 'High-energy radiation delivered from outside the body. Modern techniques include IMRT and VMAT. Usually 20-37 fractions over 4-8 weeks.',
            pros: [
                'Non-surgical, no general anaesthesia required',
                'Equivalent cancer control to surgery for localised disease',
                'Lower immediate impact on continence than surgery',
                'Can treat larger tumours and locally advanced disease',
                'Can be combined with ADT for higher-risk disease',
                'Outpatient treatment'
            ],
            cons: [
                'Daily hospital visits for 4-8 weeks',
                'Side effects may develop over time (late effects)',
                'Salvage options more limited if recurrence occurs',
                'ADT required for intermediate/high-risk (has its own side effects)',
                'Bowel side effects more common than with surgery'
            ],
            risks: [
                'Erectile dysfunction: 30-50% at 5 years',
                'Urinary symptoms: frequency, urgency, haematuria (5-15% long-term)',
                'Bowel symptoms: diarrhoea, rectal bleeding, proctitis (5-10%)',
                'Fatigue during treatment',
                'Small increased risk of secondary malignancy',
                'Urethral stricture: 2-5%'
            ],
            suitability: {
                'low': { suitable: true, note: 'Effective option but active surveillance usually preferred.' },
                'intermediate-favourable': { suitable: true, note: 'Excellent option. Consider with short-term ADT.' },
                'intermediate-unfavourable': { suitable: true, note: 'Recommended with ADT (6 months).' },
                'high': { suitable: true, note: 'Recommended with long-term ADT (2-3 years).' },
                'very-high': { suitable: true, note: 'Recommended with long-term ADT. Pelvic nodal RT indicated.' }
            },
            bausLinks: [
                { title: 'BAUS: External Beam Radiotherapy', url: 'https://www.baus.org.uk/patients/conditions/12/external_beam_radiotherapy' }
            ],
            otherLinks: [
                { title: 'Prostate Cancer UK: External Beam Radiotherapy', url: 'https://prostatecanceruk.org/prostate-information/treatments/external-beam-radiotherapy' }
            ]
        },
        'brachytherapy-ldr': {
            name: 'Low Dose Rate (LDR) Brachytherapy',
            icon: 'üíä',
            alertClass: 'alert-info',
            description: 'Permanent radioactive seeds implanted directly into the prostate. Single procedure. Seeds remain in place but radiation decays over months.',
            pros: [
                'Single outpatient/day-case procedure',
                'Quick recovery (1-2 weeks)',
                'Excellent cancer control for low and favourable intermediate-risk',
                'Lower dose to surrounding organs than EBRT',
                'No daily hospital visits',
                'Good preservation of erectile function'
            ],
            cons: [
                'Only suitable for smaller prostates (usually <50ml)',
                'Not suitable for high-risk disease as monotherapy',
                'Previous TURP may be contraindication',
                'Urinary symptoms common in first few months',
                'Radiation precautions required for several months'
            ],
            risks: [
                'Urinary retention: 5-10% may need temporary catheter',
                'Urinary symptoms: frequency, urgency common initially',
                'Erectile dysfunction: 20-40% at 5 years',
                'Rectal symptoms: uncommon but can occur',
                'Seed migration: rare, usually asymptomatic'
            ],
            suitability: {
                'low': { suitable: true, note: 'Excellent option as monotherapy.' },
                'intermediate-favourable': { suitable: true, note: 'Suitable as monotherapy for selected patients.' },
                'intermediate-unfavourable': { suitable: false, note: 'LDR monotherapy not recommended.' },
                'high': { suitable: false, note: 'Not appropriate as monotherapy.' }
            },
            bausLinks: [
                { title: 'BAUS: Brachytherapy', url: 'https://www.baus.org.uk/patients/conditions/13/brachytherapy' }
            ],
            otherLinks: [
                { title: 'Prostate Cancer UK: Brachytherapy', url: 'https://prostatecanceruk.org/prostate-information/treatments/brachytherapy' }
            ]
        },
        'brachytherapy-hdr': {
            name: 'High Dose Rate (HDR) Brachytherapy Boost',
            icon: '‚ö°',
            alertClass: 'alert-warning',
            description: 'Temporary high-dose radiation via catheters, usually combined with EBRT. Delivers very high dose to prostate.',
            pros: [
                'Allows very high dose to prostate (dose escalation)',
                'Excellent cancer control for intermediate and high-risk',
                'Shorter overall treatment time than EBRT alone',
                'Lower dose to rectum and bladder',
                'No permanent implant'
            ],
            cons: [
                'Requires 1-2 procedures under anaesthesia',
                'Still requires EBRT (though fewer fractions)',
                'Temporary catheters can be uncomfortable',
                'Not widely available at all centres'
            ],
            risks: [
                'Urinary symptoms similar to EBRT',
                'Erectile dysfunction: 30-50%',
                'Procedure-related: bleeding, infection',
                'Bowel symptoms less common than EBRT alone'
            ],
            suitability: {
                'low': { suitable: false, note: 'HDR boost not indicated for low-risk.' },
                'intermediate-favourable': { suitable: true, note: 'Can be used for dose escalation.' },
                'intermediate-unfavourable': { suitable: true, note: 'Good option combined with EBRT.' },
                'high': { suitable: true, note: 'Recommended combined with EBRT and ADT.' }
            },
            bausLinks: [
                { title: 'BAUS: Brachytherapy', url: 'https://www.baus.org.uk/patients/conditions/13/brachytherapy' }
            ],
            otherLinks: [
                { title: 'Prostate Cancer UK: HDR Brachytherapy', url: 'https://prostatecanceruk.org/prostate-information/treatments/permanent-seed-brachytherapy' }
            ]
        },
        'sbrt': {
            name: 'SBRT/SABR (5-Fraction Stereotactic Radiotherapy)',
            icon: 'üéØ',
            alertClass: 'alert-info',
            description: 'Ultra-hypofractionated radiotherapy in just 5 treatments over 1-2 weeks. Uses precise stereotactic targeting. NICE approved.',
            pros: [
                'Only 5 treatments vs 20-37 for conventional EBRT',
                'Completed in 1-2 weeks',
                'Similar cancer control to conventional EBRT in trials',
                'Convenient for patients',
                'Excellent precision with modern technology',
                'NICE approved for localised prostate cancer'
            ],
            cons: [
                'Higher dose per fraction may increase some side effect risks',
                'Requires very precise targeting',
                'Long-term data still maturing',
                'Not all centres offer this treatment'
            ],
            risks: [
                'Urinary symptoms: may be more pronounced initially',
                'Erectile dysfunction: similar to conventional EBRT (30-50%)',
                'Bowel symptoms: similar to conventional EBRT',
                'Fatigue: less cumulative than longer courses'
            ],
            suitability: {
                'low': { suitable: true, note: 'Effective option, though AS usually preferred.' },
                'intermediate-favourable': { suitable: true, note: 'Good option, particularly if convenience important.' },
                'intermediate-unfavourable': { suitable: true, note: 'Suitable with ADT.' },
                'high': { suitable: false, note: 'Limited data. Conventional EBRT usually preferred.' }
            },
            bausLinks: [
                { title: 'BAUS: External Beam Radiotherapy', url: 'https://www.baus.org.uk/patients/conditions/12/external_beam_radiotherapy' }
            ],
            otherLinks: [
                { title: 'NICE: SABR for Prostate Cancer', url: 'https://www.nice.org.uk/guidance/ipg713' },
                { title: 'Prostate Cancer UK: SABR/SBRT', url: 'https://prostatecanceruk.org/prostate-information/treatments/external-beam-radiotherapy' }
            ]
        },
        'hifu': {
            name: 'High Intensity Focused Ultrasound (HIFU)',
            icon: 'üîä',
            alertClass: 'alert-info',
            description: 'Focal therapy using focused ultrasound waves to heat and destroy prostate tissue. Can treat whole gland or focal areas. Day-case procedure.',
            pros: [
                'Minimally invasive, day-case procedure',
                'Can be focal (treating only cancer, preserving healthy tissue)',
                'Good preservation of continence and erectile function',
                'Repeatable if needed',
                'No radiation exposure',
                'Quick recovery (days to 1-2 weeks)'
            ],
            cons: [
                'Long-term data less mature than surgery/RT',
                'May not be suitable for all tumour locations',
                'Requires careful patient selection',
                'May need retreatment if cancer persists/recurs',
                'NICE recommends only in research setting or with special arrangements'
            ],
            risks: [
                'Urinary retention: may need temporary catheter',
                'Urinary tract infection',
                'Erectile dysfunction: lower risk with focal therapy (10-30%)',
                'Urethral stricture or fistula: rare',
                'Incomplete treatment requiring salvage therapy'
            ],
            suitability: {
                'low': { suitable: true, note: 'Option for selected patients. AS usually preferred.' },
                'intermediate-favourable': { suitable: true, note: 'May be suitable for focal disease.' },
                'intermediate-unfavourable': { suitable: false, note: 'Not generally recommended.' },
                'high': { suitable: false, note: 'Not appropriate for high-risk disease.' }
            },
            bausLinks: [
                { title: 'BAUS: HIFU for Prostate Cancer', url: 'https://www.baus.org.uk/patients/conditions/14/hifu' }
            ],
            otherLinks: [
                { title: 'Prostate Cancer UK: HIFU', url: 'https://prostatecanceruk.org/prostate-information/treatments/hifu' },
                { title: 'NICE: Focal HIFU', url: 'https://www.nice.org.uk/guidance/ipg424' }
            ]
        },
        'cryotherapy': {
            name: 'Cryotherapy',
            icon: '‚ùÑÔ∏è',
            alertClass: 'alert-info',
            description: 'Focal therapy using extreme cold to freeze and destroy prostate cancer cells. Probes inserted through perineum.',
            pros: [
                'Minimally invasive procedure',
                'Can be focal or whole-gland',
                'Repeatable if needed',
                'No radiation',
                'Can be used as salvage after radiotherapy failure'
            ],
            cons: [
                'Less common than other treatments in UK',
                'Long-term data limited',
                'Higher risk of erectile dysfunction than HIFU',
                'NICE recommends only in research or special arrangements'
            ],
            risks: [
                'Erectile dysfunction: 40-80% with whole gland treatment',
                'Urinary incontinence: 5-10%',
                'Urethral sloughing',
                'Rectal fistula: rare but serious',
                'Pelvic pain'
            ],
            suitability: {
                'low': { suitable: true, note: 'Option for selected patients.' },
                'intermediate-favourable': { suitable: true, note: 'May be suitable for focal disease.' },
                'high': { suitable: false, note: 'Not recommended as primary treatment.' }
            },
            bausLinks: [
                { title: 'BAUS: Cryotherapy', url: 'https://www.baus.org.uk/patients/conditions/15/cryotherapy' }
            ],
            otherLinks: [
                { title: 'Prostate Cancer UK: Cryotherapy', url: 'https://prostatecanceruk.org/prostate-information/treatments/cryotherapy' }
            ]
        },
        'adt': {
            name: 'Androgen Deprivation Therapy (ADT)',
            icon: 'üíâ',
            alertClass: 'alert-warning',
            description: 'Hormone therapy to reduce testosterone levels. Can be LHRH agonists, antagonists, or surgical castration.',
            pros: [
                'Effective at controlling cancer growth',
                'Non-surgical options available (injections)',
                'Can be used at various stages of disease',
                'Combined with RT improves outcomes',
                'First-line for metastatic disease'
            ],
            cons: [
                'Does not cure cancer - controls it',
                'Significant side effects affecting quality of life',
                'Long-term use associated with metabolic complications',
                'Cancer eventually becomes resistant'
            ],
            risks: [
                'Hot flushes: 50-80%',
                'Sexual dysfunction: loss of libido, ED (nearly universal)',
                'Fatigue and reduced energy',
                'Weight gain, loss of muscle mass',
                'Osteoporosis (long-term)',
                'Cardiovascular risk',
                'Metabolic syndrome, diabetes risk',
                'Mood changes, depression',
                'Gynaecomastia'
            ],
            suitability: {
                'low': { suitable: false, note: 'ADT alone not indicated for low-risk.' },
                'intermediate-favourable': { suitable: true, note: 'Short-term ADT with RT improves outcomes.' },
                'intermediate-unfavourable': { suitable: true, note: 'ADT with RT recommended.' },
                'high': { suitable: true, note: 'Long-term ADT with RT is standard.' },
                'metastatic': { suitable: true, note: 'ADT is mainstay of treatment.' }
            },
            bausLinks: [
                { title: 'BAUS: Hormone Therapy', url: 'https://www.baus.org.uk/patients/conditions/16/hormone_therapy' }
            ],
            otherLinks: [
                { title: 'Prostate Cancer UK: Hormone Therapy', url: 'https://prostatecanceruk.org/prostate-information/treatments/hormone-therapy' }
            ]
        },
        'adt-novel': {
            name: 'ADT + Novel Hormonal Agent',
            icon: 'üíä',
            alertClass: 'alert-urgent',
            description: 'ADT combined with Abiraterone, Enzalutamide, Apalutamide, or Darolutamide. Standard of care for metastatic hormone-sensitive disease.',
            pros: [
                'Significantly improves survival vs ADT alone',
                'Delays progression to castration-resistant disease',
                'Standard of care for metastatic disease (NICE approved)',
                'Oral medications available'
            ],
            cons: [
                'Additional side effects on top of ADT',
                'More expensive than ADT alone',
                'Requires additional monitoring',
                'Not curative'
            ],
            risks: [
                'All ADT side effects plus:',
                'Fatigue (more pronounced)',
                'Hypertension (particularly Abiraterone)',
                'Liver function abnormalities',
                'Seizure risk with Enzalutamide',
                'Falls and fractures',
                'Cardiac effects'
            ],
            suitability: {
                'metastatic': { suitable: true, note: 'Standard of care for metastatic hormone-sensitive disease.' },
                'high': { suitable: true, note: 'May be used with RT for very high-risk disease.' }
            },
            bausLinks: [
                { title: 'BAUS: Hormone Therapy', url: 'https://www.baus.org.uk/patients/conditions/16/hormone_therapy' }
            ],
            otherLinks: [
                { title: 'NICE: Abiraterone', url: 'https://www.nice.org.uk/guidance/ta741' },
                { title: 'Prostate Cancer UK: Advanced Treatments', url: 'https://prostatecanceruk.org/prostate-information/treatments' }
            ]
        },
        'chemotherapy': {
            name: 'Chemotherapy (Docetaxel)',
            icon: 'üß™',
            alertClass: 'alert-urgent',
            description: 'Cytotoxic chemotherapy for metastatic disease, either upfront with ADT or for castration-resistant disease.',
            pros: [
                'Proven survival benefit in metastatic disease',
                'Can provide rapid disease control',
                'Can be combined with ADT upfront for high-volume disease',
                'Active in castration-resistant disease'
            ],
            cons: [
                'Significant side effects',
                'IV administration every 3 weeks',
                'Regular blood tests required',
                'May not be suitable for frail patients'
            ],
            risks: [
                'Fatigue: very common',
                'Neutropenia: infection risk',
                'Peripheral neuropathy',
                'Nail changes',
                'Hair loss (usually partial)',
                'Nausea and vomiting',
                'Fluid retention',
                'Allergic reactions'
            ],
            suitability: {
                'metastatic': { suitable: true, note: 'For fit patients with high-volume metastatic disease.' }
            },
            bausLinks: [
                { title: 'BAUS: Chemotherapy', url: 'https://www.baus.org.uk/patients/conditions/17/chemotherapy' }
            ],
            otherLinks: [
                { title: 'Macmillan: Docetaxel', url: 'https://www.macmillan.org.uk/cancer-information-and-support/treatments-and-drugs/docetaxel' },
                { title: 'Prostate Cancer UK: Chemotherapy', url: 'https://prostatecanceruk.org/prostate-information/treatments/chemotherapy' }
            ]
        }
    };
    
    return treatments[treatment] || {
        name: 'Treatment Information',
        icon: 'üìã',
        alertClass: 'alert-info',
        description: 'Select a treatment to view details.',
        pros: [], cons: [], risks: [],
        suitability: {},
        bausLinks: [], otherLinks: []
    };
}

// ============================================
// STEP 6: FOLLOW-UP SCHEDULE FUNCTIONS
// ============================================

function generateFollowupSchedule() {
    const treatment = document.getElementById('s6-treatment').value;
    const treatmentDate = document.getElementById('s6-treatment-date').value;
    const riskGroup = document.getElementById('s6-risk-group').value;
    const age = parseInt(document.getElementById('s6-age').value);
    const psaNadir = parseFloat(document.getElementById('s6-psa-nadir').value);
    const margins = document.getElementById('s6-margins').value;
    
    if (!treatment) {
        document.getElementById('followup-schedule').innerHTML = '<div class="alert alert-info"><span class="alert-icon">‚ÑπÔ∏è</span><div>Please select the treatment received.</div></div>';
        return;
    }
    
    const schedule = getFollowupSchedule(treatment, riskGroup, margins, age);
    let html = '';
    
    // Header
    html += `
        <div class="alert alert-info">
            <span class="alert-icon">üìÖ</span>
            <div>
                <div class="alert-title">Follow-up Protocol: Post-${schedule.treatmentName}</div>
                <div class="alert-text">${schedule.summary}</div>
            </div>
        </div>
    `;
    
    // Calculate dates if provided
    if (treatmentDate && schedule.timeline.length > 0) {
        const baseDate = new Date(treatmentDate);
        html += '<div class="info-box" style="margin-bottom: 20px; border-left: 4px solid var(--accent-green);"><div class="info-box-title">üìÜ Scheduled Dates</div><div style="margin-top: 12px;">';
        
        schedule.timeline.forEach(item => {
            const appointmentDate = new Date(baseDate);
            appointmentDate.setMonth(appointmentDate.getMonth() + item.months);
            html += `<div style="padding: 8px 0; border-bottom: 1px solid var(--border);"><strong>${item.visit}:</strong> ${appointmentDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })} - ${item.investigations}</div>`;
        });
        
        html += '</div></div>';
    }
    
    // PSA Schedule
    html += `
        <div class="management-section">
            <div class="management-title">üî¨ PSA Monitoring Schedule</div>
            <ul class="management-list">
                ${schedule.psaSchedule.map(p => `<li>${p}</li>`).join('')}
            </ul>
        </div>
    `;
    
    // Imaging
    if (schedule.imaging.length > 0) {
        html += `
            <div class="management-section">
                <div class="management-title">üì∑ Imaging Requirements</div>
                <ul class="management-list">
                    ${schedule.imaging.map(i => `<li>${i}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    // Clinical Exam
    html += `
        <div class="management-section">
            <div class="management-title">üëÜ Clinical Examination</div>
            <ul class="management-list">
                ${schedule.clinicalExam.map(c => `<li>${c}</li>`).join('')}
            </ul>
        </div>
    `;
    
    // Triggers
    html += `
        <div class="alert alert-warning" style="margin-top: 20px;">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div>
                <div class="alert-title">Triggers for Further Investigation</div>
                <div class="alert-text">
                    <ul style="margin: 8px 0; padding-left: 20px;">
                        ${schedule.triggers.map(t => `<li>${t}</li>`).join('')}
                    </ul>
                </div>
            </div>
        </div>
    `;
    
    // Discharge
    html += `
        <div class="info-box" style="margin-top: 20px; border-left: 4px solid var(--accent-green);">
            <div class="info-box-title">‚úì Discharge Criteria</div>
            <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary);">
                ${schedule.dischargeCriteria.map(d => `<li>${d}</li>`).join('')}
            </ul>
        </div>
    `;
    
    // PIFU
    if (schedule.pifuEligible) {
        html += `
            <div class="info-box" style="margin-top: 20px;">
                <div class="info-box-title">üì± Patient Initiated Follow-Up (PIFU)</div>
                <p style="color: var(--text-secondary);">${schedule.pifuNote}</p>
            </div>
        `;
    }
    
    document.getElementById('followup-schedule').innerHTML = html;
}

function getFollowupSchedule(treatment, riskGroup, margins, age) {
    const schedules = {
        'active-surveillance': {
            treatmentName: 'Active Surveillance',
            summary: 'Regular monitoring with PSA, MRI, and biopsies only if progression suspected.',
            psaSchedule: [
                'Year 1: PSA every 3 months',
                'Year 2-5: PSA every 6 months',
                'Year 5+: PSA annually (consider discharge if stable)'
            ],
            imaging: [
                'MRI at 12 months from diagnosis',
                'Subsequent MRI: if PSA rise or clinical change',
                'No routine repeat MRI if stable'
            ],
            clinicalExam: [
                'DRE: Not routinely required (NICE NG131)',
                'Clinical review at each PSA appointment'
            ],
            triggers: [
                'PSA velocity >1 ng/ml/year',
                'PSA doubling time <3 years',
                'Change on MRI (new lesion or growth)',
                'Patient request for treatment'
            ],
            dischargeCriteria: [
                'After 10 years of stable monitoring if age >75',
                'If life expectancy <10 years - convert to watchful waiting',
                'Transfer to primary care with clear re-referral criteria'
            ],
            pifuEligible: true,
            pifuNote: 'Suitable for PIFU after Year 2 if stable.',
            timeline: [
                { months: 3, visit: '3-month PSA', investigations: 'PSA only' },
                { months: 6, visit: '6-month PSA', investigations: 'PSA only' },
                { months: 9, visit: '9-month PSA', investigations: 'PSA only' },
                { months: 12, visit: '12-month review', investigations: 'PSA + MRI + Clinical review' },
                { months: 18, visit: '18-month PSA', investigations: 'PSA only' },
                { months: 24, visit: '2-year review', investigations: 'PSA + Clinical review' }
            ]
        },
        'watchful-waiting': {
            treatmentName: 'Watchful Waiting',
            summary: 'Symptom-based monitoring. No routine PSA or imaging.',
            psaSchedule: [
                'No routine PSA monitoring',
                'PSA only if symptoms develop'
            ],
            imaging: [
                'No routine imaging',
                'Imaging only if symptomatic'
            ],
            clinicalExam: [
                'No routine appointments',
                'Patient-initiated contact if symptoms'
            ],
            triggers: [
                'Bone pain or other symptoms',
                'Urinary retention',
                'Patient request for active management'
            ],
            dischargeCriteria: [
                'Can be discharged to GP immediately',
                'Clear instructions for re-referral if symptoms'
            ],
            pifuEligible: true,
            pifuNote: 'Essentially PIFU from the start.',
            timeline: []
        },
        'radical-prostatectomy': {
            treatmentName: 'Radical Prostatectomy',
            summary: 'Post-operative surveillance. PSA should be undetectable (<0.1 ng/ml).',
            psaSchedule: [
                'First PSA at 6 weeks post-op (should be <0.1 ng/ml)',
                'Year 1: PSA every 3-4 months',
                'Year 2-5: PSA every 6 months',
                'Year 5+: PSA annually'
            ],
            imaging: [
                'No routine imaging if PSA undetectable',
                'PSMA PET-CT if biochemical recurrence (PSA ‚â•0.2 ng/ml)',
                'MRI pelvis if local recurrence suspected'
            ],
            clinicalExam: [
                'Continence assessment at each visit (Year 1)',
                'Erectile function review',
                'DRE: not routinely required post-prostatectomy'
            ],
            triggers: [
                'PSA ‚â•0.2 ng/ml (biochemical recurrence - EAU)',
                'Rising PSA on 2 consecutive measurements',
                'Any detectable PSA if previously undetectable',
                'New symptoms'
            ],
            dischargeCriteria: [
                'After 10 years with undetectable PSA',
                'Transfer to primary care with PSA protocol',
                'Clear re-referral threshold (PSA ‚â•0.1)'
            ],
            pifuEligible: true,
            pifuNote: 'Suitable for PIFU after Year 2 if PSA undetectable.',
            timeline: [
                { months: 1.5, visit: '6-week post-op', investigations: 'PSA + Wound check + Continence' },
                { months: 3, visit: '3-month', investigations: 'PSA + Continence/ED review' },
                { months: 6, visit: '6-month', investigations: 'PSA' },
                { months: 9, visit: '9-month', investigations: 'PSA' },
                { months: 12, visit: '1-year review', investigations: 'PSA + Clinical review' },
                { months: 18, visit: '18-month', investigations: 'PSA' },
                { months: 24, visit: '2-year review', investigations: 'PSA + Clinical review' }
            ]
        },
        'ebrt': {
            treatmentName: 'External Beam Radiotherapy',
            summary: 'Post-RT surveillance. PSA falls slowly - nadir may take 18-24 months.',
            psaSchedule: [
                'First PSA at 3 months post-RT',
                'Year 1-2: PSA every 3-6 months (monitoring nadir)',
                'Year 2-5: PSA every 6 months',
                'Year 5+: PSA annually'
            ],
            imaging: [
                'No routine imaging',
                'MRI/PSMA PET if biochemical recurrence',
                'Bone scan if bone pain'
            ],
            clinicalExam: [
                'Toxicity assessment (urinary, bowel, sexual)',
                'DRE: can be performed but not routine'
            ],
            triggers: [
                'PSA rise ‚â•2 ng/ml above nadir (Phoenix definition)',
                'PSA rising on 3 consecutive tests',
                'New urinary or bowel symptoms',
                'Bone pain'
            ],
            dischargeCriteria: [
                'After 5-10 years with stable PSA',
                'Transfer to primary care with PSA protocol'
            ],
            pifuEligible: true,
            pifuNote: 'PIFU appropriate after Year 2 if PSA stable.',
            timeline: [
                { months: 3, visit: '3-month', investigations: 'PSA + Toxicity review' },
                { months: 6, visit: '6-month', investigations: 'PSA' },
                { months: 12, visit: '1-year review', investigations: 'PSA + Clinical review' },
                { months: 18, visit: '18-month', investigations: 'PSA' },
                { months: 24, visit: '2-year review', investigations: 'PSA + Clinical review' }
            ]
        },
        'ebrt-adt': {
            treatmentName: 'EBRT + ADT',
            summary: 'Combined treatment follow-up. Monitor for testosterone recovery after stopping ADT.',
            psaSchedule: [
                'PSA every 3-6 months during ADT',
                'Monitor testosterone recovery after ADT stops',
                'Year 1-2: PSA every 3-6 months',
                'Year 2-5: PSA every 6 months',
                'Year 5+: PSA annually'
            ],
            imaging: [
                'No routine imaging',
                'PSMA PET if biochemical failure after testosterone recovery'
            ],
            clinicalExam: [
                'ADT side effect monitoring',
                'Bone health assessment (DEXA if long-term ADT)',
                'Cardiovascular risk review'
            ],
            triggers: [
                'PSA rise ‚â•2 ng/ml above nadir (after testosterone recovery)',
                'Testosterone not recovering (check level)',
                'New symptoms'
            ],
            dischargeCriteria: [
                'After 5-10 years with stable PSA and testosterone recovered',
                'ADT completed and PSA stable'
            ],
            pifuEligible: true,
            pifuNote: 'PIFU after ADT completed and PSA stable.',
            timeline: [
                { months: 3, visit: '3-month', investigations: 'PSA + ADT review' },
                { months: 6, visit: '6-month', investigations: 'PSA + Testosterone' },
                { months: 12, visit: '1-year', investigations: 'PSA + Clinical review' },
                { months: 24, visit: '2-year', investigations: 'PSA + Testosterone recovery check' },
                { months: 36, visit: '3-year (if ADT stopping)', investigations: 'PSA + Testosterone' }
            ]
        },
        'brachytherapy': {
            treatmentName: 'Brachytherapy',
            summary: 'Similar to EBRT follow-up. PSA may take 2-3 years to reach nadir. PSA bounce common.',
            psaSchedule: [
                'First PSA at 6 weeks',
                'Year 1-2: PSA every 3-6 months',
                'Year 2-5: PSA every 6 months',
                'Year 5+: PSA annually',
                'Note: PSA bounce (rise then fall) common in first 2 years'
            ],
            imaging: [
                'No routine imaging',
                'PSMA PET if true biochemical recurrence suspected'
            ],
            clinicalExam: [
                'Urinary symptom review (IPSS)',
                'Sexual function assessment'
            ],
            triggers: [
                'PSA rise ‚â•2 ng/ml above nadir (Phoenix)',
                'Distinguish from PSA bounce (usually <2 ng/ml, resolves)',
                'Persistent urinary symptoms'
            ],
            dischargeCriteria: [
                'After 5-10 years with stable PSA',
                'Transfer to primary care'
            ],
            pifuEligible: true,
            pifuNote: 'PIFU after Year 2 if stable (accounting for PSA bounce).',
            timeline: [
                { months: 1.5, visit: '6-week', investigations: 'PSA + Symptom review' },
                { months: 3, visit: '3-month', investigations: 'PSA' },
                { months: 6, visit: '6-month', investigations: 'PSA' },
                { months: 12, visit: '1-year', investigations: 'PSA + Clinical review' },
                { months: 24, visit: '2-year', investigations: 'PSA + Review (nadir expected)' }
            ]
        },
        'sbrt': {
            treatmentName: 'SBRT (5-Fraction RT)',
            summary: 'Similar follow-up to conventional EBRT. Less long-term data but emerging evidence supportive.',
            psaSchedule: [
                'First PSA at 3 months',
                'Year 1-2: PSA every 3-6 months',
                'Year 2-5: PSA every 6 months',
                'Year 5+: PSA annually'
            ],
            imaging: [
                'No routine imaging',
                'PSMA PET if biochemical recurrence'
            ],
            clinicalExam: [
                'Toxicity assessment',
                'Similar to conventional EBRT'
            ],
            triggers: [
                'PSA rise ‚â•2 ng/ml above nadir',
                'New urinary/bowel symptoms'
            ],
            dischargeCriteria: [
                'After 5-10 years with stable PSA'
            ],
            pifuEligible: true,
            pifuNote: 'PIFU after Year 2 if stable.',
            timeline: [
                { months: 3, visit: '3-month', investigations: 'PSA + Toxicity' },
                { months: 6, visit: '6-month', investigations: 'PSA' },
                { months: 12, visit: '1-year', investigations: 'PSA + Clinical review' },
                { months: 24, visit: '2-year', investigations: 'PSA + Review' }
            ]
        },
        'hifu': {
            treatmentName: 'HIFU',
            summary: 'Close follow-up required. MRI important for monitoring. May need retreatment.',
            psaSchedule: [
                'PSA at 6 weeks, then every 3 months Year 1',
                'Year 2+: PSA every 6 months',
                'PSA nadir variable depending on whole-gland vs focal'
            ],
            imaging: [
                'MRI at 6-12 months to assess treatment effect',
                'Repeat MRI if PSA rising or concern'
            ],
            clinicalExam: [
                'Urinary symptom review',
                'Sexual function assessment'
            ],
            triggers: [
                'Rising PSA',
                'Suspicious findings on MRI',
                'May need re-biopsy to confirm recurrence'
            ],
            dischargeCriteria: [
                'If stable at 5 years, consider discharge',
                'Many centres follow longer due to limited data'
            ],
            pifuEligible: false,
            pifuNote: 'PIFU generally not appropriate - closer monitoring needed.',
            timeline: [
                { months: 1.5, visit: '6-week', investigations: 'PSA + Symptom review' },
                { months: 3, visit: '3-month', investigations: 'PSA' },
                { months: 6, visit: '6-month', investigations: 'PSA + MRI' },
                { months: 12, visit: '1-year', investigations: 'PSA + Clinical review' }
            ]
        },
        'cryotherapy': {
            treatmentName: 'Cryotherapy',
            summary: 'Similar to HIFU follow-up. Close monitoring with PSA and MRI.',
            psaSchedule: [
                'PSA at 6 weeks, then every 3 months Year 1',
                'Year 2+: PSA every 6 months'
            ],
            imaging: [
                'MRI at 6-12 months',
                'Repeat imaging if PSA rising'
            ],
            clinicalExam: [
                'Urinary and sexual function review',
                'Monitor for complications'
            ],
            triggers: [
                'Rising PSA',
                'MRI changes',
                'Symptoms'
            ],
            dischargeCriteria: [
                'Consider discharge at 5 years if stable'
            ],
            pifuEligible: false,
            pifuNote: 'Closer monitoring generally needed.',
            timeline: [
                { months: 1.5, visit: '6-week', investigations: 'PSA + Symptom review' },
                { months: 3, visit: '3-month', investigations: 'PSA' },
                { months: 6, visit: '6-month', investigations: 'PSA + Consider MRI' },
                { months: 12, visit: '1-year', investigations: 'PSA + MRI + Review' }
            ]
        },
        'adt-only': {
            treatmentName: 'ADT Alone',
            summary: 'Ongoing monitoring of disease control and treatment side effects.',
            psaSchedule: [
                'PSA every 3 months initially',
                'Once stable: PSA every 3-6 months',
                'Monitor for castration-resistant disease (rising PSA despite castrate testosterone)'
            ],
            imaging: [
                'Imaging if symptoms or PSA rising despite ADT',
                'Bone scan/CT/PSMA PET as indicated'
            ],
            clinicalExam: [
                'ADT side effect monitoring',
                'Bone health (DEXA scan)',
                'Cardiovascular risk',
                'Metabolic monitoring (glucose, lipids)'
            ],
            triggers: [
                'Rising PSA despite castrate testosterone (<50 ng/dL) = CRPC',
                'New symptoms',
                'Imaging progression'
            ],
            dischargeCriteria: [
                'Usually ongoing follow-up required',
                'May transfer to oncology if progression'
            ],
            pifuEligible: false,
            pifuNote: 'Regular monitoring required - PIFU not appropriate.',
            timeline: [
                { months: 3, visit: '3-month', investigations: 'PSA + Testosterone + Side effects' },
                { months: 6, visit: '6-month', investigations: 'PSA + Clinical review' },
                { months: 12, visit: '1-year', investigations: 'PSA + DEXA + Metabolic screen' }
            ]
        }
    };
    
    return schedules[treatment] || {
        treatmentName: 'Treatment',
        summary: 'Please select a treatment to generate follow-up schedule.',
        psaSchedule: [],
        imaging: [],
        clinicalExam: [],
        triggers: [],
        dischargeCriteria: [],
        pifuEligible: false,
        pifuNote: '',
        timeline: []
    };
}

// ============================================
// STEP 7: PROGRESSION MANAGEMENT FUNCTIONS
// ============================================

function generateProgressionManagement() {
    const initialTreatment = document.getElementById('s7-initial-treatment').value;
    const treatmentDate = document.getElementById('s7-treatment-date').value;
    const age = parseInt(document.getElementById('s7-age').value);
    const psaNadir = parseFloat(document.getElementById('s7-psa-nadir').value);
    const currentPSA = parseFloat(document.getElementById('s7-current-psa').value);
    const psaDoubling = parseFloat(document.getElementById('s7-psa-doubling').value);
    const originalGleason = document.getElementById('s7-original-gleason').value;
    const progressionType = document.getElementById('s7-progression-type').value;
    
    const asymptomatic = document.getElementById('s7-asymptomatic').checked;
    const bonePain = document.getElementById('s7-bone-pain').checked;
    const luts = document.getElementById('s7-luts').checked;
    const fatigue = document.getElementById('s7-fatigue').checked;
    
    if (!initialTreatment || !progressionType) {
        document.getElementById('progression-management').innerHTML = '<div class="alert alert-info"><span class="alert-icon">‚ÑπÔ∏è</span><div>Please complete initial treatment and progression type.</div></div>';
        return;
    }
    
    // Calculate time from treatment
    let monthsFromTreatment = null;
    if (treatmentDate) {
        const treatDate = new Date(treatmentDate);
        const now = new Date();
        monthsFromTreatment = Math.floor((now - treatDate) / (1000 * 60 * 60 * 24 * 30));
    }
    
    let html = '';
    
    // Determine recurrence type
    const isEarlyRecurrence = monthsFromTreatment && monthsFromTreatment < 24;
    const isAggressiveFeatures = psaDoubling && psaDoubling < 10;
    const isHighGrade = originalGleason && parseInt(originalGleason) >= 4;
    
    // Alert based on urgency
    let alertClass = 'alert-warning';
    let alertIcon = '‚ö†Ô∏è';
    let alertTitle = 'Biochemical Recurrence Detected';
    
    if (progressionType === 'metastatic' || progressionType === 'symptomatic') {
        alertClass = 'alert-urgent';
        alertIcon = 'üö®';
        alertTitle = 'Disease Progression - Urgent Assessment Required';
    }
    
    html += `
        <div class="alert ${alertClass}">
            <span class="alert-icon">${alertIcon}</span>
            <div>
                <div class="alert-title">${alertTitle}</div>
                <div class="alert-text">
                    Initial treatment: ${initialTreatment.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}<br>
                    ${monthsFromTreatment ? `Time from treatment: ${monthsFromTreatment} months<br>` : ''}
                    ${currentPSA ? `Current PSA: ${currentPSA} ng/ml<br>` : ''}
                    ${psaDoubling ? `PSA doubling time: ${psaDoubling} months` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Risk stratification
    let riskFactors = [];
    if (isEarlyRecurrence) riskFactors.push('Early recurrence (<2 years from treatment)');
    if (isAggressiveFeatures) riskFactors.push('Short PSA doubling time (<10 months)');
    if (isHighGrade) riskFactors.push('High-grade disease (Grade Group ‚â•4)');
    if (progressionType === 'metastatic') riskFactors.push('Metastatic disease');
    
    if (riskFactors.length > 0) {
        html += `
            <div class="info-box" style="margin-bottom: 20px; border-left: 4px solid var(--accent-red);">
                <div class="info-box-title">‚ö†Ô∏è Adverse Prognostic Features</div>
                <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary);">
                    ${riskFactors.map(r => `<li>${r}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    // Investigations required
    html += `
        <div class="management-section">
            <div class="management-title">üî¨ Recommended Investigations</div>
            <ul class="management-list">
                <li><strong>Confirm biochemical recurrence:</strong> Repeat PSA to confirm rise</li>
                <li><strong>PSMA PET-CT:</strong> First-line imaging for localising recurrence (NICE NG131)</li>
                <li><strong>If PSMA unavailable:</strong> MRI pelvis ¬± bone scan ¬± CT CAP</li>
                ${progressionType === 'symptomatic' || bonePain ? '<li><strong>Urgent bone scan/CT:</strong> If bone pain or neurological symptoms</li>' : ''}
                ${luts ? '<li><strong>Flexible cystoscopy:</strong> If significant urinary symptoms</li>' : ''}
            </ul>
        </div>
    `;
    
    // Treatment recommendations based on initial treatment
    const salvageTreatments = getSalvageTreatments(initialTreatment, progressionType, isEarlyRecurrence, isAggressiveFeatures, age);
    
    html += `
        <div class="management-section">
            <div class="management-title">üéØ Treatment Options</div>
            <div class="investigation-list">
    `;
    
    salvageTreatments.forEach(tx => {
        html += `
            <div class="investigation-item ${tx.priority}" style="flex-direction: column; align-items: flex-start;">
                <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                    <div class="investigation-icon">${tx.icon}</div>
                    <div class="investigation-details">
                        <div class="investigation-name">${tx.name}</div>
                        <div class="investigation-desc">${tx.description}</div>
                    </div>
                    <span class="investigation-priority priority-${tx.priority}">${tx.priorityLabel}</span>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; width: 100%;">
                    <div style="margin-bottom: 8px;"><strong style="color: var(--accent-green);">‚úì Pros:</strong></div>
                    <ul style="margin: 0 0 12px 20px; padding: 0; font-size: 0.85rem; color: var(--text-secondary);">
                        ${tx.pros.map(p => `<li>${p}</li>`).join('')}
                    </ul>
                    <div style="margin-bottom: 8px;"><strong style="color: var(--accent-amber);">‚ö† Cons:</strong></div>
                    <ul style="margin: 0 0 12px 20px; padding: 0; font-size: 0.85rem; color: var(--text-secondary);">
                        ${tx.cons.map(c => `<li>${c}</li>`).join('')}
                    </ul>
                    <div style="margin-bottom: 8px;"><strong style="color: var(--accent-red);">‚õî Risks:</strong></div>
                    <ul style="margin: 0 0 0 20px; padding: 0; font-size: 0.85rem; color: var(--text-secondary);">
                        ${tx.risks.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    });
    
    html += `</div></div>`;
    
    // Prognosis
    html += `
        <div class="info-box" style="margin-top: 20px;">
            <div class="info-box-title">üìà Prognosis Considerations</div>
            <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary);">
                ${!isAggressiveFeatures ? '<li>PSA doubling time >10 months is favourable - median time to metastases may be >10 years without treatment</li>' : '<li>Short PSA doubling time indicates more aggressive disease - earlier intervention often recommended</li>'}
                ${progressionType === 'biochemical' ? '<li>Biochemical recurrence without radiological disease may have good long-term outcomes</li>' : ''}
                ${initialTreatment === 'radical-prostatectomy' ? '<li>Post-prostatectomy recurrence: if PSA <0.5 and localised on imaging, salvage RT very effective</li>' : ''}
                <li>MDT discussion essential for optimal treatment selection</li>
            </ul>
        </div>
    `;
    
    // MDT
    html += `
        <div class="alert alert-info" style="margin-top: 20px;">
            <span class="alert-icon">üë•</span>
            <div>
                <div class="alert-title">MDT Discussion Required</div>
                <div class="alert-text">
                    All cases of biochemical recurrence should be discussed at MDT. Consider:
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        <li>Original staging and pathology</li>
                        <li>Time to recurrence and PSA kinetics</li>
                        <li>PSMA PET-CT findings</li>
                        <li>Patient fitness, preferences and comorbidities</li>
                        <li>Options for local vs systemic salvage therapy</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    
    // Resources
    html += `
        <div class="info-box" style="margin-top: 20px;">
            <div class="info-box-title">üìö Patient Information</div>
            <div style="margin-top: 12px;">
                <a href="https://prostatecanceruk.org/prostate-information/living-with-prostate-cancer/if-your-cancer-comes-back" target="_blank" style="display: block; color: var(--accent-cyan); margin-bottom: 8px;">üìÑ Prostate Cancer UK: If Your Cancer Comes Back</a>
                <a href="https://www.macmillan.org.uk/cancer-information-and-support/prostate-cancer/if-prostate-cancer-comes-back" target="_blank" style="display: block; color: var(--accent-cyan); margin-bottom: 8px;">üìÑ Macmillan: Recurrent Prostate Cancer</a>
            </div>
        </div>
    `;
    
    document.getElementById('progression-management').innerHTML = html;
}

function getSalvageTreatments(initialTreatment, progressionType, isEarly, isAggressive, age) {
    let treatments = [];
    
    if (initialTreatment === 'radical-prostatectomy') {
        if (progressionType === 'biochemical' || progressionType === 'local') {
            treatments.push({
                name: 'Salvage Radiotherapy (SRT)',
                icon: '‚ò¢Ô∏è',
                description: 'Radiotherapy to prostate bed ¬± pelvic nodes. Most effective if PSA <0.5 ng/ml.',
                priority: 'recommended',
                priorityLabel: 'First-line',
                pros: [
                    'Potentially curative for local recurrence',
                    'Most effective early (PSA <0.5)',
                    '50-70% achieve undetectable PSA',
                    'Can be combined with short-term ADT'
                ],
                cons: [
                    'May cause bowel/bladder side effects',
                    'Takes 4-7 weeks of daily treatment',
                    'May affect continence recovery',
                    'Less effective if delayed'
                ],
                risks: [
                    'Urinary frequency/urgency',
                    'Bowel symptoms (diarrhoea, bleeding)',
                    'Worsening incontinence',
                    'Erectile dysfunction'
                ]
            });
        }
        
        if (progressionType === 'nodal' || (progressionType === 'biochemical' && isAggressive)) {
            treatments.push({
                name: 'Salvage RT + ADT',
                icon: 'üíä',
                description: 'Radiotherapy combined with hormone therapy for higher-risk recurrence.',
                priority: 'recommended',
                priorityLabel: 'Recommended',
                pros: [
                    'Better outcomes than RT alone for higher-risk',
                    'Addresses systemic disease component',
                    'RADICALS-HD trial supports combination'
                ],
                cons: [
                    'ADT side effects added to RT side effects',
                    'Longer treatment duration',
                    'Impact on quality of life'
                ],
                risks: [
                    'All RT side effects plus ADT side effects',
                    'Hot flushes, fatigue, sexual dysfunction',
                    'Metabolic effects'
                ]
            });
        }
    }
    
    if (initialTreatment === 'ebrt' || initialTreatment === 'ebrt-adt' || initialTreatment === 'brachytherapy') {
        if (progressionType === 'biochemical' || progressionType === 'local') {
            treatments.push({
                name: 'Salvage Prostatectomy',
                icon: 'üî™',
                description: 'Surgical removal after radiotherapy failure. Complex surgery with higher complication rates.',
                priority: 'optional',
                priorityLabel: 'Selected cases',
                pros: [
                    'Potentially curative for local-only recurrence',
                    'Removes all prostate tissue',
                    'Provides histological confirmation'
                ],
                cons: [
                    'Technically challenging surgery',
                    'Higher complication rates than primary surgery',
                    'Not widely available',
                    'Requires careful patient selection'
                ],
                risks: [
                    'Incontinence: 20-50%',
                    'Erectile dysfunction: very high',
                    'Rectal injury: 2-5%',
                    'Anastomotic stricture'
                ]
            });
            
            treatments.push({
                name: 'Salvage HIFU',
                icon: 'üîä',
                description: 'Focal ultrasound ablation for local recurrence after RT.',
                priority: 'optional',
                priorityLabel: 'Selected cases',
                pros: [
                    'Less invasive than surgery',
                    'Can be focal',
                    'Repeatable',
                    'Day-case procedure'
                ],
                cons: [
                    'Limited availability',
                    'Outcomes less well established',
                    'May need retreatment'
                ],
                risks: [
                    'Urinary retention',
                    'Incontinence: 10-20%',
                    'Fistula risk (post-RT field)',
                    'Incomplete treatment'
                ]
            });
            
            treatments.push({
                name: 'Salvage Cryotherapy',
                icon: '‚ùÑÔ∏è',
                description: 'Freezing treatment for local recurrence post-RT.',
                priority: 'optional',
                priorityLabel: 'Selected cases',
                pros: [
                    'Minimally invasive',
                    'Can be repeated',
                    'Alternative to surgery'
                ],
                cons: [
                    'High rates of erectile dysfunction',
                    'Limited centres offering this',
                    'Long-term data limited'
                ],
                risks: [
                    'Erectile dysfunction: 70-90%',
                    'Incontinence: 10-15%',
                    'Rectal fistula risk',
                    'Urethral sloughing'
                ]
            });
        }
    }
    
    if (initialTreatment === 'active-surveillance') {
        treatments.push({
            name: 'Radical Prostatectomy',
            icon: 'üî™',
            description: 'Primary surgical treatment following AS progression.',
            priority: 'recommended',
            priorityLabel: 'Recommended',
            pros: [
                'Full pathological staging',
                'Potentially curative',
                'Not compromised by prior RT'
            ],
            cons: [
                'Major surgery',
                'Recovery time',
                'Impact on continence/sexual function'
            ],
            risks: [
                'Standard prostatectomy risks',
                'See Step 5 for full details'
            ]
        });
        
        treatments.push({
            name: 'Radiotherapy ¬± ADT',
            icon: '‚ò¢Ô∏è',
            description: 'Primary radiotherapy following AS progression.',
            priority: 'recommended',
            priorityLabel: 'Recommended',
            pros: [
                'Non-surgical option',
                'Can treat larger volume disease',
                'Equivalent cancer control'
            ],
            cons: [
                'Daily treatment for weeks',
                'May need ADT',
                'Salvage options limited if fails'
            ],
            risks: [
                'Standard RT risks',
                'See Step 5 for full details'
            ]
        });
    }
    
    // Always offer ADT for progression
    if (progressionType === 'metastatic' || progressionType === 'nodal') {
        treatments.push({
            name: 'ADT + Novel Hormonal Agent',
            icon: 'üíä',
            description: 'Systemic therapy for metastatic recurrence.',
            priority: 'urgent',
            priorityLabel: 'Urgent',
            pros: [
                'Systemic disease control',
                'Survival benefit proven',
                'Can control disease for years'
            ],
            cons: [
                'Not curative',
                'Significant side effects',
                'Will eventually become resistant'
            ],
            risks: [
                'Hot flushes, fatigue',
                'Sexual dysfunction',
                'Metabolic complications',
                'Bone health'
            ]
        });
    }
    
    // Observation option for slow kinetics
    if (progressionType === 'biochemical' && !isAggressive && (!age || age > 70)) {
        treatments.push({
            name: 'Active Monitoring',
            icon: 'üëÅÔ∏è',
            description: 'Close PSA surveillance without immediate treatment for low-risk biochemical recurrence.',
            priority: 'optional',
            priorityLabel: 'Consider',
            pros: [
                'Avoids treatment side effects',
                'Appropriate if slow PSA kinetics',
                'May not affect overall survival if asymptomatic',
                'Treatment can start later if needed'
            ],
            cons: [
                'Psychological burden',
                'Risk of disease progression',
                'May miss optimal treatment window'
            ],
            risks: [
                'Disease progression',
                'Development of metastases',
                'Anxiety'
            ]
        });
    }
    
    return treatments;
}
    </script>
</body>
</html>
